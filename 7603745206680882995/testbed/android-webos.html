<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Android WebOS 仿真系统</title>
    <script src="https://cdn.tailwindcss.com/3.4.13"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'android-blue': '#1a73e8',
                        'android-dark': '#202124',
                        'android-surface': '#303134',
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out',
                        'slide-down': 'slideDown 0.3s ease-out',
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'bounce-subtle': 'bounceSubtle 0.5s ease-out',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' }
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-100%)' },
                            '100%': { transform: 'translateY(0)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        bounceSubtle: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(1.05)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body {
            overscroll-behavior: none;
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .app-icon {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .app-icon:active {
            transform: scale(0.95);
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .glass-effect {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        .text-shadow {
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .notification-item {
            transition: all 0.3s ease;
        }
        
        .notification-item:active {
            transform: scale(0.98);
        }
        
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .ripple:active::after {
            width: 200px;
            height: 200px;
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">
    <!-- 主容器 - 模拟手机屏幕 -->
    <div id="phoneScreen" class="relative mx-auto max-w-md h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-pink-900 overflow-hidden">
        
        <!-- 状态栏 -->
        <div id="statusBar" class="absolute top-0 left-0 right-0 h-8 bg-black bg-opacity-40 glass-effect flex items-center justify-between px-4 text-white text-xs z-50">
            <div class="flex items-center gap-2">
                <span id="currentTime">12:00</span>
            </div>
            <div class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                </svg>
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                </svg>
                <span id="batteryLevel">85%</span>
            </div>
        </div>

        <!-- 锁屏界面 -->
        <div id="lockScreen" class="absolute inset-0 bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 flex flex-col items-center justify-center z-40 transition-opacity duration-500">
            <div class="text-center text-white">
                <div id="lockTime" class="text-7xl font-light mb-2">12:00</div>
                <div id="lockDate" class="text-xl opacity-80 mb-12">星期一，1月 1日</div>
            </div>
            <div class="absolute bottom-20 text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>
                    </svg>
                </div>
                <p class="text-white text-sm opacity-80">向上滑动解锁</p>
            </div>
        </div>

        <!-- 主屏幕 -->
        <div id="homeScreen" class="absolute inset-0 pt-8 pb-32 flex flex-col opacity-0 pointer-events-none transition-opacity duration-300">
            <!-- 壁纸 -->
            <div class="absolute inset-0 bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 opacity-90"></div>
            
            <!-- 时钟小部件 -->
            <div class="relative px-6 pt-8 mb-4">
                <div class="bg-white bg-opacity-10 glass-effect rounded-3xl p-6 text-white text-shadow">
                    <div id="widgetTime" class="text-5xl font-light mb-1">12:00</div>
                    <div id="widgetDate" class="text-lg opacity-90">星期一，1月 1日</div>
                </div>
            </div>

            <!-- 应用图标网格 -->
            <div id="appGrid" class="relative px-6 grid grid-cols-4 gap-5 overflow-y-auto scrollbar-hide flex-1 content-start pb-4">
                <!-- 应用图标将通过 JS 动态生成 -->
            </div>
        </div>

        <!-- Dock 栏 -->
        <div id="dockBar" class="absolute bottom-12 left-0 right-0 h-20 bg-black bg-opacity-40 glass-effect flex items-center justify-around px-8 z-30 opacity-0 pointer-events-none transition-opacity duration-300">
            <div class="app-icon flex flex-col items-center" data-app="phone">
                <div class="w-14 h-14 rounded-2xl bg-green-500 flex items-center justify-center shadow-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                    </svg>
                </div>
            </div>
            <div class="app-icon flex flex-col items-center" data-app="messages">
                <div class="w-14 h-14 rounded-2xl bg-blue-500 flex items-center justify-center shadow-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                </div>
            </div>
            <div class="app-icon flex flex-col items-center" data-app="browser">
                <div class="w-14 h-14 rounded-2xl bg-blue-600 flex items-center justify-center shadow-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                    </svg>
                </div>
            </div>
            <div class="app-icon flex flex-col items-center" data-app="camera">
                <div class="w-14 h-14 rounded-2xl bg-gray-700 flex items-center justify-center shadow-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- 通知中心 -->
        <div id="notificationPanel" class="absolute inset-0 bg-black bg-opacity-95 glass-effect z-40 transform -translate-y-full transition-transform duration-300">
            <div class="p-6 pt-12">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-white text-2xl font-medium">通知</h2>
                    <button id="closeNotifications" class="text-white opacity-70">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <!-- 快捷设置 -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <button class="quick-setting ripple bg-android-blue rounded-2xl p-4 text-white text-center">
                        <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>
                        </svg>
                        <span class="text-xs">WiFi</span>
                    </button>
                    <button class="quick-setting ripple bg-android-surface rounded-2xl p-4 text-white text-center">
                        <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0"/>
                        </svg>
                        <span class="text-xs">蓝牙</span>
                    </button>
                    <button class="quick-setting ripple bg-android-surface rounded-2xl p-4 text-white text-center">
                        <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        <span class="text-xs">亮度</span>
                    </button>
                </div>

                <!-- 通知列表 -->
                <div id="notificationList" class="space-y-3 overflow-y-auto scrollbar-hide" style="max-height: calc(100vh - 320px);">
                    <!-- 通知项将通过 JS 动态生成 -->
                </div>
            </div>
        </div>

        <!-- 应用窗口容器 -->
        <div id="appWindow" class="absolute inset-0 bg-white z-50 transform translate-y-full transition-transform duration-300">
            <!-- 应用内容将动态加载 -->
        </div>

        <!-- 导航栏 -->
        <div id="navBar" class="absolute bottom-0 left-0 right-0 h-12 bg-black flex items-center justify-around z-30 opacity-0 pointer-events-none transition-opacity duration-300">
            <button id="backBtn" class="w-12 h-12 flex items-center justify-center text-white ripple">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <button id="homeBtn" class="w-12 h-12 flex items-center justify-center text-white ripple">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
            </button>
            <button id="recentBtn" class="w-12 h-12 flex items-center justify-center text-white ripple">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // ==================== 全局状态管理 ====================
        const AppState = {
            isLocked: true,
            currentApp: null,
            notifications: [],
            fileSystem: null,
            fsVersion: 1,
            files: {
                cwd: '/',
                selected: null,
            },
            contacts: [
                { id: 1, name: '张三', phone: '138****1234', avatar: 'Z' },
                { id: 2, name: '李四', phone: '139****5678', avatar: 'L' },
                { id: 3, name: '王五', phone: '136****9012', avatar: 'W' }
            ],
            messages: [
                { id: 1, contactId: 1, text: '你好，最近怎么样？', time: '10:30', isMe: false },
                { id: 2, contactId: 1, text: '挺好的，你呢？', time: '10:32', isMe: true },
                { id: 3, contactId: 2, text: '明天见面吗？', time: '昨天', isMe: false }
            ],
            currentChatId: null,
            emails: [
                { id: 1, from: 'noreply@android.example', subject: '欢迎使用 Android WebOS', time: '09:12', body: '欢迎！这是一个移动端 WebOS 仿真系统。你可以在“文件”“文本编辑器”“相机/照片”等应用之间共享统一文件系统。' },
                { id: 2, from: 'team@demo.example', subject: '今日待办', time: '昨天', body: '1) 打开浏览器查看离线 Demo 页面\n2) 用相机拍一张照片并在照片应用中预览\n3) 在文本编辑器写点东西并保存到 Documents' }
            ],
            currentEmailId: null,
            browserHistory: [],
            browser: {
                url: 'webos://start',
                stack: ['webos://start'],
            },
            editor: {
                path: '/Documents/notes.txt',
                draft: '',
                dirty: false,
            },
            photoViewer: {
                path: null,
            },
            recents: []
        };

        // ==================== 应用配置 ====================
        const Apps = {
            phone: {
                name: '电话',
                icon: 'M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z',
                color: 'bg-green-500'
            },
            messages: {
                name: '信息',
                icon: 'M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z',
                color: 'bg-blue-500'
            },
            browser: {
                name: '浏览器',
                icon: 'M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9',
                color: 'bg-blue-600'
            },
            camera: {
                name: '相机',
                icon: 'M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z M15 13a3 3 0 11-6 0 3 3 0 016 0z',
                color: 'bg-gray-700'
            },
            photos: {
                name: '照片',
                icon: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z',
                color: 'bg-pink-500'
            },
            files: {
                name: '文件',
                icon: 'M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z',
                color: 'bg-yellow-500'
            },
            editor: {
                name: '文本编辑',
                icon: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z',
                color: 'bg-orange-400'
            },
            mail: {
                name: '邮件',
                icon: 'M3 8l7.89 5.26a2 2 0 002.22 0L21 8m-18 8h18a2 2 0 002-2V8a2 2 0 00-2-2H3a2 2 0 00-2 2v6a2 2 0 002 2z',
                color: 'bg-rose-500'
            },
            settings: {
                name: '设置',
                icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z',
                color: 'bg-gray-600'
            },
            calculator: {
                name: '计算器',
                icon: 'M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z',
                color: 'bg-indigo-500'
            },
            music: {
                name: '音乐',
                icon: 'M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3',
                color: 'bg-red-500'
            },
            clock: {
                name: '时钟',
                icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z',
                color: 'bg-blue-400'
            },
            weather: {
                name: '天气',
                icon: 'M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z',
                color: 'bg-cyan-400'
            }
        };

        // ==================== 持久化与统一文件系统 ====================
        const STORAGE_KEY = 'android_webos_state_v1';

        function nowTimeHHMM() {
            return new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function normalizePath(path) {
            if (!path) return '/';
            let p = String(path).trim();
            if (!p.startsWith('/')) p = '/' + p;
            p = p.replace(/\/+/g, '/');
            if (p.length > 1 && p.endsWith('/')) p = p.slice(0, -1);
            return p;
        }

        function splitPath(path) {
            const p = normalizePath(path);
            if (p === '/') return [];
            return p.slice(1).split('/');
        }

        function fsBootstrap() {
            const root = {
                type: 'dir',
                children: {
                    Documents: { type: 'dir', children: {} },
                    Pictures: { type: 'dir', children: {} },
                    Downloads: { type: 'dir', children: {} },
                    Music: { type: 'dir', children: {} },
                    Videos: { type: 'dir', children: {} }
                }
            };

            root.children.Documents.children['notes.txt'] = {
                type: 'file',
                mime: 'text/plain',
                content: '欢迎使用 Android WebOS 文本编辑器。\n\n- 在“文件”里新建/删除文件夹或文件\n- 在“相机”拍照后会保存到 Pictures\n- 在“照片”里可预览/删除图片\n'
            };

            root.children.Downloads.children['demo.html'] = {
                type: 'file',
                mime: 'text/html',
                content: '<!doctype html><meta charset="utf-8"><title>Demo</title><h1>离线 Demo 页面</h1><p>这是浏览器内置的离线示例网页。</p>'
            };

            AppState.fileSystem = { '/': root };
        }

        function fsGetRoot() {
            if (!AppState.fileSystem) fsBootstrap();
            return AppState.fileSystem['/'];
        }

        function fsGetNode(path) {
            const parts = splitPath(path);
            let node = fsGetRoot();
            for (const part of parts) {
                if (!node || node.type !== 'dir') return null;
                node = node.children?.[part] ?? null;
            }
            return node;
        }

        function fsGetParent(path) {
            const p = normalizePath(path);
            if (p === '/') return { parent: null, name: '/', path: '/' };
            const parts = splitPath(p);
            const name = parts.pop();
            const parentPath = '/' + parts.join('/');
            const parent = fsGetNode(parentPath === '/' ? '/' : parentPath);
            return { parent, name, path: parentPath === '' ? '/' : parentPath };
        }

        function fsListDir(path) {
            const dir = fsGetNode(path);
            if (!dir || dir.type !== 'dir') return [];
            return Object.entries(dir.children || {}).map(([name, node]) => ({ name, node }));
        }

        function fsEnsureDir(path) {
            const parts = splitPath(path);
            let node = fsGetRoot();
            for (const part of parts) {
                if (!node.children) node.children = {};
                if (!node.children[part]) node.children[part] = { type: 'dir', children: {} };
                node = node.children[part];
                if (node.type !== 'dir') return false;
            }
            return true;
        }

        function fsWriteFile(path, content, mime = 'text/plain') {
            const p = normalizePath(path);
            const { parent, name } = fsGetParent(p);
            if (!parent || parent.type !== 'dir') return false;
            if (!parent.children) parent.children = {};
            parent.children[name] = { type: 'file', mime, content: String(content ?? '') };
            persist();
            return true;
        }

        function fsReadFile(path) {
            const node = fsGetNode(path);
            if (!node || node.type !== 'file') return null;
            return node.content ?? '';
        }

        function fsCreateDir(path) {
            const p = normalizePath(path);
            const { parent, name } = fsGetParent(p);
            if (!parent || parent.type !== 'dir') return false;
            if (!parent.children) parent.children = {};
            if (parent.children[name]) return false;
            parent.children[name] = { type: 'dir', children: {} };
            persist();
            return true;
        }

        function fsDelete(path) {
            const p = normalizePath(path);
            if (p === '/') return false;
            const { parent, name } = fsGetParent(p);
            if (!parent || parent.type !== 'dir' || !parent.children?.[name]) return false;
            delete parent.children[name];
            persist();
            return true;
        }

        function fsGuessMime(name) {
            const lower = String(name).toLowerCase();
            if (lower.endsWith('.png')) return 'image/png';
            if (lower.endsWith('.jpg') || lower.endsWith('.jpeg')) return 'image/jpeg';
            if (lower.endsWith('.gif')) return 'image/gif';
            if (lower.endsWith('.webp')) return 'image/webp';
            if (lower.endsWith('.html') || lower.endsWith('.htm')) return 'text/html';
            if (lower.endsWith('.md')) return 'text/markdown';
            return 'text/plain';
        }

        function isImageMime(mime) {
            return typeof mime === 'string' && mime.startsWith('image/');
        }

        function persist() {
            const payload = {
                fsVersion: AppState.fsVersion,
                fileSystem: AppState.fileSystem,
                messages: AppState.messages,
                emails: AppState.emails
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
            } catch (e) {
                // ignore quota errors
            }
        }

        function hydrate() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) {
                    fsBootstrap();
                    return;
                }
                const data = JSON.parse(raw);
                if (data?.fileSystem) AppState.fileSystem = data.fileSystem;
                if (!AppState.fileSystem) fsBootstrap();
                if (Array.isArray(data?.messages)) AppState.messages = data.messages;
                if (Array.isArray(data?.emails)) AppState.emails = data.emails;
            } catch (e) {
                fsBootstrap();
            }
        }

        // ==================== 工具函数 ====================
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
            const dateStr = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' });
            
            document.getElementById('currentTime').textContent = timeStr;
            document.getElementById('lockTime').textContent = timeStr;
            document.getElementById('widgetTime').textContent = timeStr;
            document.getElementById('lockDate').textContent = dateStr;
            document.getElementById('widgetDate').textContent = dateStr;
        }

        function unlockScreen() {
            AppState.isLocked = false;
            document.getElementById('lockScreen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('lockScreen').style.display = 'none';
                document.getElementById('homeScreen').style.opacity = '1';
                document.getElementById('homeScreen').style.pointerEvents = 'auto';
                document.getElementById('dockBar').style.opacity = '1';
                document.getElementById('dockBar').style.pointerEvents = 'auto';
                document.getElementById('navBar').style.opacity = '1';
                document.getElementById('navBar').style.pointerEvents = 'auto';
            }, 300);
        }

        function lockScreen() {
            AppState.isLocked = true;
            document.getElementById('homeScreen').style.opacity = '0';
            document.getElementById('homeScreen').style.pointerEvents = 'none';
            document.getElementById('dockBar').style.opacity = '0';
            document.getElementById('dockBar').style.pointerEvents = 'none';
            document.getElementById('navBar').style.opacity = '0';
            document.getElementById('navBar').style.pointerEvents = 'none';
            document.getElementById('lockScreen').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('lockScreen').style.opacity = '1';
            }, 10);
        }

        // ==================== 应用渲染函数 ====================
        function renderAppGrid() {
            const grid = document.getElementById('appGrid');
            grid.innerHTML = '';
            
            const order = ['phone', 'messages', 'browser', 'camera', 'photos', 'files', 'editor', 'mail', 'settings', 'calculator', 'music', 'clock', 'weather'];
            const ids = order.filter(id => Apps[id]).concat(Object.keys(Apps).filter(id => !order.includes(id)));

            ids.forEach((appId, index) => {
                const app = Apps[appId];
                const appDiv = document.createElement('div');
                appDiv.className = 'app-icon flex flex-col items-center animate-scale-in';
                appDiv.style.animationDelay = `${index * 0.05}s`;
                appDiv.dataset.app = appId;
                
                appDiv.innerHTML = `
                    <div class="w-14 h-14 rounded-2xl ${app.color} flex items-center justify-center shadow-lg mb-2">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${app.icon}"/>
                        </svg>
                    </div>
                    <span class="text-white text-xs text-shadow">${app.name}</span>
                `;
                
                grid.appendChild(appDiv);
            });
        }

        function openApp(appId) {
            AppState.currentApp = appId;
            const appWindow = document.getElementById('appWindow');
            
            // 渲染应用内容
            appWindow.innerHTML = getAppContent(appId);
            
            // 显示应用窗口
            appWindow.style.transform = 'translateY(0)';
            
            const existingIndex = AppState.recents.findIndex(x => x.appId === appId);
            if (existingIndex !== -1) AppState.recents.splice(existingIndex, 1);
            AppState.recents.unshift({ appId, time: nowTimeHHMM() });
            AppState.recents = AppState.recents.slice(0, 12);

            // 初始化应用特定功能
            initAppFunctions(appId);
        }

        function closeApp() {
            const appWindow = document.getElementById('appWindow');
            appWindow.style.transform = 'translateY(100%)';
            AppState.currentApp = null;
        }

        function getAppContent(appId) {
            const templates = {
                phone: getPhoneApp(),
                messages: getMessagesApp(),
                browser: getBrowserApp(),
                camera: getCameraApp(),
                photos: getPhotosApp(),
                files: getFilesApp(),
                settings: getSettingsApp(),
                calculator: getCalculatorApp(),
                music: getMusicApp(),
                clock: getClockApp(),
                editor: getEditorApp(),
                mail: getMailApp(),
                weather: getWeatherApp()
            };
            
            return templates[appId] || '<div class="p-4">应用开发中...</div>';
        }

        // ==================== 各应用界面模板 ====================
        function getPhoneApp() {
            return `
                <div class="h-full flex flex-col bg-white">
                    <div class="bg-green-500 text-white p-4 flex items-center">
                        <button onclick="closeApp()" class="mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-medium">电话</h1>
                    </div>
                    
                    <div class="flex border-b text-sm">
                        <button id="phone-tab-contacts" class="flex-1 py-3 font-medium text-green-600 border-b-2 border-green-600" onclick="Phone_setTab('contacts')">联系人</button>
                        <button id="phone-tab-recents" class="flex-1 py-3 text-gray-500 hover:text-gray-700 active:bg-gray-100" onclick="Phone_setTab('recents')">通话记录</button>
                        <button id="phone-tab-dialer" class="flex-1 py-3 text-gray-500 hover:text-gray-700 active:bg-gray-100" onclick="Phone_setTab('dialer')">拨号</button>
                    </div>
                    <div id="phone-body" class="flex-1 overflow-y-auto"></div>
                </div>
            `;
        }

        function getMessagesApp() {
            return `
                <div class="h-full flex flex-col bg-white">
                    <div class="bg-blue-500 text-white p-4 flex items-center">
                        <button onclick="closeApp()" class="mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-medium">信息</h1>
                    </div>
                    
                    <div id="messages-body" class="flex-1 overflow-y-auto"></div>
                </div>
            `;
        }

        function getBrowserApp() {
            return `
                <div class="h-full flex flex-col bg-white">
                    <div class="bg-blue-600 text-white p-4">
                        <div class="flex items-center mb-3">
                            <button onclick="closeApp()" class="mr-4">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                </svg>
                            </button>
                            <h1 class="text-xl font-medium">浏览器</h1>
                        </div>
                        <div class="flex items-center bg-white rounded-full px-4 py-2">
                            <svg class="w-5 h-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <input type="text" placeholder="搜索或输入网址" class="flex-1 outline-none text-gray-800" id="browserInput" autocomplete="off" inputmode="url">
                            <button id="browserGo" class="ml-2 text-blue-600 font-medium hover:opacity-80 active:opacity-60">前往</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto bg-gray-50">
                        <div class="p-4">
                            <div class="bg-white rounded-2xl shadow-sm p-4">
                                <h2 class="font-medium mb-3">快捷入口</h2>
                                <div class="grid grid-cols-4 gap-4">
                                    ${[
                                        { title: '开始页', url: 'webos://start' },
                                        { title: '离线 Wiki', url: 'webos://wiki' },
                                        { title: '文件 Demo', url: 'webos://files' },
                                        { title: '关于', url: 'webos://about' },
                                    ].map(item => `
                                        <button class="ripple flex flex-col items-center" onclick="Browser_navigate('${item.url}')">
                                            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-medium mb-1 shadow">
                                                ${item.title[0]}
                                            </div>
                                            <span class="text-xs text-gray-700">${item.title}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div id="browserPage" class="px-4 pb-4"></div>
                    </div>
                </div>
            `;
        }

        function getCameraApp() {
            return `
                <div class="h-full flex flex-col bg-black">
                    <div class="absolute top-0 left-0 right-0 z-10 p-4 flex justify-between items-center">
                        <button onclick="closeApp()" class="text-white">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        <div class="flex gap-4">
                            <button class="text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                            </button>
                            <button class="text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex-1 flex items-center justify-center p-6">
                        <div class="w-full aspect-[3/4] max-h-[72vh] rounded-3xl overflow-hidden bg-gradient-to-br from-gray-900 via-gray-800 to-black border border-white/10 shadow-2xl relative">
                            <div id="cameraPreview" class="absolute inset-0"></div>
                            <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_20%,rgba(255,255,255,.12),transparent_48%),radial-gradient(circle_at_80%_70%,rgba(59,130,246,.14),transparent_55%)]"></div>
                            <div class="absolute top-4 left-4 text-white/80 text-xs bg-black/35 rounded-full px-3 py-1">预览（模拟）</div>
                        </div>
                    </div>
                    
                    <div class="absolute bottom-0 left-0 right-0 p-6 flex justify-around items-center">
                        <button class="w-12 h-12 rounded-2xl bg-white bg-opacity-20 hover:bg-opacity-30 active:bg-opacity-15 transition flex items-center justify-center" onclick="openApp('photos')">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </button>
                        <button id="captureBtn" class="w-20 h-20 rounded-full bg-white border-4 border-gray-300 hover:scale-105 transition-transform"></button>
                        <button class="w-12 h-12 rounded-2xl bg-white bg-opacity-20 hover:bg-opacity-30 active:bg-opacity-15 transition flex items-center justify-center" onclick="Camera_toggleFlash()">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        function getPhotosApp() {
            return `
                <div class="h-full flex flex-col bg-white">
                    <div class="bg-pink-500 text-white p-4 flex items-center">
                        <button onclick="closeApp()" class="mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-medium">照片</h1>
                    </div>
                    <div class="flex-1 overflow-y-auto p-3">
                        <div id="photos-grid" class="grid grid-cols-3 gap-2"></div>
                        <div id="photos-empty" class="hidden text-center py-12 text-gray-500">
                            <div class="mx-auto w-16 h-16 rounded-2xl bg-pink-50 flex items-center justify-center mb-3">
                                <svg class="w-8 h-8 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <p class="font-medium">暂无照片</p>
                            <p class="text-sm mt-1">打开“相机”拍照后会自动保存到 Pictures</p>
                            <button class="mt-4 px-4 py-2 rounded-xl bg-pink-500 text-white hover:opacity-90 active:opacity-70" onclick="openApp('camera')">去拍一张</button>
                        </div>
                    </div>

                    <div id="photo-viewer" class="hidden absolute inset-0 bg-black/95 z-10">
                        <div class="absolute top-0 left-0 right-0 p-4 flex items-center justify-between text-white">
                            <button class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 active:bg-white/5" onclick="Photos_closeViewer()">关闭</button>
                            <div class="text-sm opacity-80" id="photo-viewer-name">—</div>
                            <button class="px-3 py-2 rounded-xl bg-rose-500/90 hover:bg-rose-500 active:bg-rose-600" onclick="Photos_deleteCurrent()">删除</button>
                        </div>
                        <div class="h-full w-full flex items-center justify-center p-6">
                            <img id="photo-viewer-img" alt="photo" class="max-h-full max-w-full rounded-2xl shadow-2xl" />
                        </div>
                    </div>
                </div>
            `;
        }

        function getFilesApp() {
            return `
                <div class="h-full flex flex-col bg-white">
                    <div class="bg-yellow-500 text-white p-4 flex items-center">
                        <button onclick="closeApp()" class="mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <div class="flex-1 min-w-0">
                            <h1 class="text-xl font-medium">文件</h1>
                            <p id="files-path" class="text-xs text-white/85 truncate">/</p>
                        </div>
                        <button class="ml-2 px-3 py-2 rounded-xl bg-white/15 hover:bg-white/20 active:bg-white/10" onclick="Files_newFolder()">新建文件夹</button>
                        <button class="ml-2 px-3 py-2 rounded-xl bg-white/15 hover:bg-white/20 active:bg-white/10" onclick="Files_newFile()">新建文件</button>
                    </div>
                    
                    <div class="p-3 bg-gray-50 border-b flex items-center gap-2">
                        <button class="px-3 py-2 rounded-xl bg-white border hover:bg-gray-50 active:bg-gray-100" onclick="Files_up()">上级</button>
                        <button class="px-3 py-2 rounded-xl bg-white border hover:bg-gray-50 active:bg-gray-100" onclick="Files_go('/')">根目录</button>
                        <div class="flex-1"></div>
                        <button class="px-3 py-2 rounded-xl bg-white border hover:bg-gray-50 active:bg-gray-100" onclick="Files_refresh()">刷新</button>
                    </div>

                    <div id="files-list" class="flex-1 overflow-y-auto"></div>
                </div>
            `;
        }

        function getEditorApp() {
            return `
                <div class="h-full flex flex-col bg-white">
                    <div class="bg-orange-400 text-white p-4 flex items-center">
                        <button onclick="closeApp()" class="mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <div class="flex-1 min-w-0">
                            <h1 class="text-xl font-medium">文本编辑器</h1>
                            <p id="editor-path" class="text-xs text-white/90 truncate">—</p>
                        </div>
                        <button id="editor-save" class="ml-2 px-3 py-2 rounded-xl bg-white/15 hover:bg-white/20 active:bg-white/10">保存</button>
                        <button class="ml-2 px-3 py-2 rounded-xl bg-white/15 hover:bg-white/20 active:bg-white/10" onclick="Editor_saveAs()">另存为</button>
                    </div>
                    <div class="p-3 bg-gray-50 border-b flex gap-2 items-center">
                        <button class="px-3 py-2 rounded-xl bg-white border hover:bg-gray-50 active:bg-gray-100" onclick="Editor_pickFile()">打开…</button>
                        <button class="px-3 py-2 rounded-xl bg-white border hover:bg-gray-50 active:bg-gray-100" onclick="Editor_newFile()">新建</button>
                        <div class="flex-1 text-xs text-gray-500 truncate" id="editor-hint">统一文件系统：保存后可在“文件”里看到</div>
                    </div>
                    <div class="flex-1 p-3">
                        <textarea id="editor-textarea" class="w-full h-full resize-none outline-none text-[15px] leading-relaxed font-mono bg-white rounded-2xl border border-gray-200 p-4 focus:border-orange-300"></textarea>
                    </div>
                </div>
            `;
        }

        function getMailApp() {
            return `
                <div class="h-full flex flex-col bg-white">
                    <div class="bg-rose-500 text-white p-4 flex items-center">
                        <button onclick="closeApp()" class="mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-medium">邮件</h1>
                    </div>
                    <div id="mail-body" class="flex-1 overflow-y-auto bg-gray-50"></div>
                </div>
            `;
        }

        function getSettingsApp() {
            return `
                <div class="h-full flex flex-col bg-gray-50">
                    <div class="bg-gray-700 text-white p-4 flex items-center">
                        <button onclick="closeApp()" class="mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-medium">设置</h1>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto">
                        ${[
                            { icon: 'M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0', title: 'WLAN', subtitle: '未连接' },
                            { icon: 'M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z', title: '显示', subtitle: '亮度、壁纸' },
                            { icon: 'M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9', title: '声音和振动', subtitle: '音量、铃声' },
                            { icon: 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z', title: '安全', subtitle: '锁屏、指纹' },
                            { icon: 'M13 10V3L4 14h7v7l9-11h-7z', title: '电池', subtitle: '85% 剩余' },
                            { icon: 'M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4', title: '存储', subtitle: '32GB 可用' },
                            { icon: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z', title: '账号', subtitle: '用户设置' },
                            { icon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z', title: '关于手机', subtitle: 'Android 14' }
                        ].map(item => `
                            <div class="bg-white border-b flex items-center p-4 hover:bg-gray-50 active:bg-gray-100">
                                <svg class="w-6 h-6 text-gray-600 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${item.icon}"/>
                                </svg>
                                <div class="flex-1">
                                    <div class="font-medium">${item.title}</div>
                                    <div class="text-sm text-gray-500">${item.subtitle}</div>
                                </div>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getCalculatorApp() {
            return `
                <div class="h-full flex flex-col bg-gray-900">
                    <div class="bg-gray-800 text-white p-4 flex items-center">
                        <button onclick="closeApp()" class="mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-medium">计算器</h1>
                    </div>
                    
                    <div class="flex-1 flex flex-col">
                        <div class="flex-1 flex items-end justify-end p-6">
                            <div id="calcDisplay" class="text-white text-5xl font-light">0</div>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-2 p-4">
                            ${['C', '⌫', '%', '÷', '7', '8', '9', '×', '4', '5', '6', '-', '1', '2', '3', '+', '0', '.', '='].map(btn => `
                                <button class="calc-btn h-16 rounded-xl text-2xl font-medium ${
                                    ['C', '⌫', '%'].includes(btn) ? 'bg-gray-700 text-white' :
                                    ['÷', '×', '-', '+', '='].includes(btn) ? 'bg-indigo-600 text-white' :
                                    'bg-gray-800 text-white'
                                } hover:opacity-80 active:opacity-60 transition-opacity" data-value="${btn}">
                                    ${btn}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function getMusicApp() {
            return `
                <div class="h-full flex flex-col bg-gradient-to-b from-purple-900 to-black">
                    <div class="bg-black bg-opacity-50 text-white p-4 flex items-center">
                        <button onclick="closeApp()" class="mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-medium">音乐</h1>
                    </div>
                    
                    <div class="flex-1 flex flex-col items-center justify-center p-8 text-white">
                        <div class="w-64 h-64 rounded-3xl bg-gradient-to-br from-pink-500 to-purple-600 mb-8 flex items-center justify-center shadow-2xl">
                            <svg class="w-32 h-32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                            </svg>
                        </div>
                        
                        <h2 class="text-2xl font-medium mb-2">暂无播放</h2>
                        <p class="text-gray-400 mb-8">选择音乐开始播放</p>
                        
                        <div class="w-full mb-6">
                            <div class="h-1 bg-gray-700 rounded-full">
                                <div class="h-1 bg-white rounded-full w-0"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-400 mt-2">
                                <span>0:00</span>
                                <span>0:00</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-8">
                            <button class="text-white opacity-70">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.333 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z"/>
                                </svg>
                            </button>
                            <button class="w-16 h-16 rounded-full bg-white text-black flex items-center justify-center">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </button>
                            <button class="text-white opacity-70">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.933 12.8a1 1 0 000-1.6L6.6 7.2A1 1 0 005 8v8a1 1 0 001.6.8l5.333-4zM19.933 12.8a1 1 0 000-1.6l-5.333-4A1 1 0 0013 8v8a1 1 0 001.6.8l5.333-4z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getClockApp() {
            return `
                <div class="h-full flex flex-col bg-gray-900">
                    <div class="bg-gray-800 text-white p-4 flex items-center">
                        <button onclick="closeApp()" class="mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-medium">时钟</h1>
                    </div>
                    
                    <div class="flex border-b border-gray-700">
                        <button class="flex-1 py-3 text-blue-400 border-b-2 border-blue-400">闹钟</button>
                        <button class="flex-1 py-3 text-gray-400">世界时钟</button>
                        <button class="flex-1 py-3 text-gray-400">计时器</button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-4">
                        <div class="text-center text-white py-12">
                            <svg class="w-24 h-24 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-gray-400">暂无闹钟</p>
                        </div>
                    </div>
                    
                    <button class="absolute bottom-20 right-6 w-14 h-14 bg-blue-500 rounded-full shadow-lg flex items-center justify-center text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                    </button>
                </div>
            `;
        }

        function getNotesApp() {
            return `
                <div class="h-full flex flex-col bg-yellow-50">
                    <div class="bg-orange-400 text-white p-4 flex items-center">
                        <button onclick="closeApp()" class="mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-medium">备忘录</h1>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-4">
                        <div class="text-center py-12 text-gray-500">
                            <svg class="w-24 h-24 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            <p>暂无备忘录</p>
                        </div>
                    </div>
                    
                    <button class="absolute bottom-20 right-6 w-14 h-14 bg-orange-400 rounded-full shadow-lg flex items-center justify-center text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                    </button>
                </div>
            `;
        }

        function getWeatherApp() {
            return `
                <div class="h-full flex flex-col bg-gradient-to-b from-blue-400 to-blue-600">
                    <div class="bg-black bg-opacity-20 text-white p-4 flex items-center">
                        <button onclick="closeApp()" class="mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h1 class="text-xl font-medium">天气</h1>
                    </div>
                    
                    <div class="flex-1 flex flex-col items-center justify-center text-white p-8">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-light mb-2">北京</h2>
                            <p class="text-lg opacity-80">多云</p>
                        </div>
                        
                        <div class="text-center mb-12">
                            <svg class="w-32 h-32 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                            </svg>
                            <div class="text-7xl font-light mb-2">22°</div>
                            <p class="text-lg opacity-80">体感温度 20°</p>
                        </div>
                        
                        <div class="w-full grid grid-cols-3 gap-4 text-center">
                            <div class="bg-white bg-opacity-20 rounded-2xl p-4">
                                <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                                </svg>
                                <p class="text-sm opacity-80">风速</p>
                                <p class="text-xl font-medium">12 km/h</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-2xl p-4">
                                <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                                </svg>
                                <p class="text-sm opacity-80">湿度</p>
                                <p class="text-xl font-medium">65%</p>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-2xl p-4">
                                <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                <p class="text-sm opacity-80">能见度</p>
                                <p class="text-xl font-medium">10 km</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== 应用特定功能初始化 ====================
        function initAppFunctions(appId) {
            if (appId === 'calculator') {
                initCalculator();
            } else if (appId === 'phone') {
                Phone_render();
            } else if (appId === 'camera') {
                initCamera();
            } else if (appId === 'files') {
                Files_refresh();
            } else if (appId === 'photos') {
                Photos_refresh();
            } else if (appId === 'messages') {
                Messages_render();
            } else if (appId === 'browser') {
                Browser_render();
            } else if (appId === 'editor') {
                Editor_init();
            } else if (appId === 'mail') {
                Mail_render();
            }
        }

        function initCalculator() {
            let display = '0';
            let currentValue = 0;
            let operator = null;
            let waitingForOperand = false;

            const displayEl = document.getElementById('calcDisplay');
            const buttons = document.querySelectorAll('.calc-btn');

            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const value = btn.dataset.value;

                    if (!isNaN(value) || value === '.') {
                        if (waitingForOperand) {
                            display = value;
                            waitingForOperand = false;
                        } else {
                            display = display === '0' ? value : display + value;
                        }
                    } else if (value === 'C') {
                        display = '0';
                        currentValue = 0;
                        operator = null;
                        waitingForOperand = false;
                    } else if (value === '⌫') {
                        display = display.length > 1 ? display.slice(0, -1) : '0';
                    } else if (['+', '-', '×', '÷', '%'].includes(value)) {
                        const inputValue = parseFloat(display);
                        if (operator && waitingForOperand) {
                            operator = value;
                        } else {
                            if (operator) {
                                const result = calculate(currentValue, inputValue, operator);
                                display = String(result);
                                currentValue = result;
                            } else {
                                currentValue = inputValue;
                            }
                            operator = value;
                            waitingForOperand = true;
                        }
                    } else if (value === '=') {
                        const inputValue = parseFloat(display);
                        if (operator) {
                            const result = calculate(currentValue, inputValue, operator);
                            display = String(result);
                            currentValue = result;
                            operator = null;
                            waitingForOperand = true;
                        }
                    }

                    displayEl.textContent = display;
                });
            });

            function calculate(a, b, op) {
                switch (op) {
                    case '+': return a + b;
                    case '-': return a - b;
                    case '×': return a * b;
                    case '÷': return a / b;
                    case '%': return a % b;
                    default: return b;
                }
            }
        }

        function initCamera() {
            const captureBtn = document.getElementById('captureBtn');
            if (captureBtn) {
                captureBtn.addEventListener('click', () => {
                    captureBtn.classList.add('animate-bounce-subtle');
                    setTimeout(() => {
                        captureBtn.classList.remove('animate-bounce-subtle');
                        const result = Camera_captureToPictures();
                        if (result?.path) {
                            addNotification('照片已保存', `已保存到 ${result.path}`);
                        } else {
                            addNotification('保存失败', '存储空间不足或发生错误');
                        }
                    }, 500);
                });
            }
        }

        let Camera_flashOn = false;
        function Camera_toggleFlash() {
            Camera_flashOn = !Camera_flashOn;
            addNotification('相机', Camera_flashOn ? '闪光灯：开（模拟）' : '闪光灯：关（模拟）');
        }

        function Camera_captureToPictures() {
            try {
                const canvas = document.createElement('canvas');
                canvas.width = 720;
                canvas.height = 960;
                const ctx = canvas.getContext('2d');
                const g = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                const hue = Math.floor(Math.random() * 360);
                g.addColorStop(0, `hsl(${hue} 80% 55%)`);
                g.addColorStop(1, `hsl(${(hue + 70) % 360} 80% 40%)`);
                ctx.fillStyle = g;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = 'rgba(0,0,0,.25)';
                ctx.fillRect(0, canvas.height - 140, canvas.width, 140);

                ctx.fillStyle = 'rgba(255,255,255,.92)';
                ctx.font = 'bold 42px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
                ctx.fillText('Android WebOS', 36, canvas.height - 78);
                ctx.font = '24px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
                const stamp = new Date().toLocaleString('zh-CN', { hour12: false });
                ctx.fillText(stamp, 36, canvas.height - 38);

                const dataUrl = canvas.toDataURL('image/png');
                fsEnsureDir('/Pictures');
                const filename = `IMG_${Date.now()}.png`;
                const path = `/Pictures/${filename}`;
                const ok = fsWriteFile(path, dataUrl, 'image/png');
                if (!ok) return null;
                return { path };
            } catch (e) {
                return null;
            }
        }

        // ==================== 通知系统 ====================
        function addNotification(title, content) {
            const notification = {
                id: Date.now(),
                title,
                content,
                time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
            };
            
            AppState.notifications.unshift(notification);
            renderNotifications();
        }

        function renderNotifications() {
            const list = document.getElementById('notificationList');
            if (AppState.notifications.length === 0) {
                list.innerHTML = '<div class="text-center py-8 text-gray-400">暂无通知</div>';
                return;
            }
            
            list.innerHTML = AppState.notifications.map(notif => `
                <div class="notification-item bg-gray-800 rounded-2xl p-4 mb-3">
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="text-white font-medium">${notif.title}</h3>
                        <span class="text-xs text-gray-400">${notif.time}</span>
                    </div>
                    <p class="text-sm text-gray-300">${notif.content}</p>
                </div>
            `).join('');
        }

        // ==================== 事件监听 ====================
        function initEventListeners() {
            // 锁屏解锁
            let touchStartY = 0;
            const lockScreen = document.getElementById('lockScreen');
            
            lockScreen.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            });
            
            lockScreen.addEventListener('touchmove', (e) => {
                const touchY = e.touches[0].clientY;
                const deltaY = touchY - touchStartY;
                
                if (deltaY < -100) {
                    unlockScreen();
                }
            });

            // 状态栏下拉通知
            let statusTouchStartY = 0;
            const statusBar = document.getElementById('statusBar');
            const notificationPanel = document.getElementById('notificationPanel');
            
            statusBar.addEventListener('touchstart', (e) => {
                statusTouchStartY = e.touches[0].clientY;
            });
            
            statusBar.addEventListener('touchmove', (e) => {
                const touchY = e.touches[0].clientY;
                const deltaY = touchY - statusTouchStartY;
                
                if (deltaY > 100 && !AppState.isLocked) {
                    notificationPanel.style.transform = 'translateY(0)';
                }
            });

            // 关闭通知面板
            document.getElementById('closeNotifications').addEventListener('click', () => {
                notificationPanel.style.transform = 'translateY(-100%)';
            });

            // 应用图标点击
            document.addEventListener('click', (e) => {
                const appIcon = e.target.closest('.app-icon');
                if (appIcon) {
                    const appId = appIcon.dataset.app;
                    if (appId) {
                        openApp(appId);
                    }
                }
            });

            // 导航按钮
            document.getElementById('backBtn').addEventListener('click', () => {
                if (AppState.currentApp) {
                    if (!App_back()) closeApp();
                }
            });

            document.getElementById('homeBtn').addEventListener('click', () => {
                if (AppState.currentApp) {
                    closeApp();
                } else if (!AppState.isLocked) {
                    // 已在主屏幕，可以添加其他逻辑
                }
            });

            document.getElementById('recentBtn').addEventListener('click', () => {
                Recents_show();
            });

            // 快捷设置按钮
            document.querySelectorAll('.quick-setting').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.classList.toggle('bg-android-blue');
                    this.classList.toggle('bg-android-surface');
                });
            });
        }

        // ==================== 初始化 ====================
        function init() {
            hydrate();
            updateTime();
            setInterval(updateTime, 1000);
            
            renderAppGrid();
            renderNotifications();
            initEventListeners();
            
            // 添加示例通知
            setTimeout(() => {
                addNotification('欢迎使用', 'Android WebOS 仿真系统已就绪');
            }, 2000);
        }

        // ==================== 应用内导航与逻辑 ====================
        function App_back() {
            if (AppState.currentApp === 'messages' && AppState.currentChatId) {
                AppState.currentChatId = null;
                Messages_render();
                return true;
            }
            if (AppState.currentApp === 'mail' && AppState.currentEmailId) {
                AppState.currentEmailId = null;
                Mail_render();
                return true;
            }
            if (AppState.currentApp === 'photos' && AppState.photoViewer.path) {
                Photos_closeViewer();
                return true;
            }
            if (AppState.currentApp === 'browser' && AppState.browser.stack.length > 1) {
                AppState.browser.stack.pop();
                AppState.browser.url = AppState.browser.stack[AppState.browser.stack.length - 1];
                Browser_render();
                return true;
            }
            return false;
        }

        // Phone
        const PhoneState = { tab: 'contacts', dial: '', inCall: null, recents: [] };
        function Phone_setTab(tab) {
            PhoneState.tab = tab;
            Phone_render();
        }
        function Phone_render() {
            const updateTab = (tabId, active) => {
                const el = document.getElementById(tabId);
                if (!el) return;
                el.className = active
                    ? 'flex-1 py-3 font-medium text-green-600 border-b-2 border-green-600'
                    : 'flex-1 py-3 text-gray-500 hover:text-gray-700 active:bg-gray-100';
            };
            updateTab('phone-tab-contacts', PhoneState.tab === 'contacts');
            updateTab('phone-tab-recents', PhoneState.tab === 'recents');
            updateTab('phone-tab-dialer', PhoneState.tab === 'dialer');

            const body = document.getElementById('phone-body');
            if (!body) return;
            if (PhoneState.inCall) {
                const contactName = PhoneState.inCall.name || PhoneState.inCall.number;
                body.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-b from-green-50 to-white">
                        <div class="w-20 h-20 rounded-full bg-green-500 text-white flex items-center justify-center text-3xl font-semibold mb-4">${(contactName || '?')[0] || '?'}</div>
                        <div class="text-xl font-semibold">${contactName}</div>
                        <div id="call-timer" class="mt-1 text-gray-500">正在通话…</div>
                        <button class="mt-8 w-16 h-16 rounded-full bg-red-500 text-white flex items-center justify-center hover:opacity-90 active:opacity-70" onclick="Phone_hangup()">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 15.46v3a2 2 0 01-2.18 2A19.79 19.79 0 013 5.18 2 2 0 015 3h3a2 2 0 012 1.72c.12.81.29 1.6.51 2.36a2 2 0 01-.45 1.94L8.09 10.91a16 16 0 006 6l1.89-1.97a2 2 0 011.94-.45c.76.22 1.55.39 2.36.51A2 2 0 0121 15.46z"/>
                            </svg>
                        </button>
                    </div>
                `;
                Phone_updateTimer();
                return;
            }

            if (PhoneState.tab === 'dialer') {
                body.innerHTML = `
                    <div class="p-4">
                        <div class="bg-gray-50 rounded-2xl p-4 border">
                            <div class="text-sm text-gray-500">号码</div>
                            <div id="dial-display" class="text-3xl font-semibold tracking-wider mt-1 tabular-nums">${PhoneState.dial || '—'}</div>
                            <div class="mt-3 flex gap-2">
                                <button class="px-3 py-2 rounded-xl bg-white border hover:bg-gray-50 active:bg-gray-100" onclick="Phone_backspace()">⌫</button>
                                <button class="px-3 py-2 rounded-xl bg-white border hover:bg-gray-50 active:bg-gray-100" onclick="Phone_clear()">清空</button>
                                <div class="flex-1"></div>
                                <button class="px-4 py-2 rounded-xl bg-green-500 text-white hover:opacity-90 active:opacity-70" onclick="Phone_callDial()">拨打</button>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-3 gap-3">
                            ${['1','2','3','4','5','6','7','8','9','*','0','#'].map(k => `
                                <button class="ripple h-16 rounded-2xl bg-white border text-2xl font-medium hover:bg-gray-50 active:bg-gray-100" onclick="Phone_key('${k}')">${k}</button>
                            `).join('')}
                        </div>
                    </div>
                `;
                return;
            }

            if (PhoneState.tab === 'recents') {
                const items = PhoneState.recents.slice(0, 30);
                body.innerHTML = `
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm text-gray-500">最近</div>
                            <button class="text-sm text-green-600 hover:opacity-80 active:opacity-60" onclick="Phone_clearRecents()">清除</button>
                        </div>
                        <div class="bg-white rounded-2xl border overflow-hidden">
                            ${items.length ? items.map(x => `
                                <div class="flex items-center gap-3 p-4 border-b last:border-b-0 hover:bg-gray-50 active:bg-gray-100">
                                    <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center font-semibold">${(x.name || x.number || '?')[0] || '?'}</div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium truncate">${x.name || x.number}</div>
                                        <div class="text-xs text-gray-500">${x.time}</div>
                                    </div>
                                    <button class="px-3 py-2 rounded-xl bg-green-50 text-green-700 hover:bg-green-100 active:bg-green-200" onclick="Phone_call('${x.number}', '${x.name || ''}')">拨打</button>
                                </div>
                            `).join('') : `<div class="p-6 text-center text-gray-500">暂无通话记录</div>`}
                        </div>
                    </div>
                `;
                return;
            }

            body.innerHTML = `
                <div class="p-4">
                    <div class="bg-white rounded-2xl border overflow-hidden">
                        ${AppState.contacts.map(contact => `
                            <div class="flex items-center p-4 border-b last:border-b-0 hover:bg-gray-50 active:bg-gray-100">
                                <div class="w-12 h-12 rounded-full bg-green-500 flex items-center justify-center text-white font-medium mr-4">${contact.avatar}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium truncate">${contact.name}</div>
                                    <div class="text-sm text-gray-500">${contact.phone}</div>
                                </div>
                                <button class="text-green-600 p-2 rounded-xl hover:bg-green-50 active:bg-green-100" onclick="Phone_call('${contact.phone}','${contact.name}')">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        let Phone_timer = null;
        function Phone_call(number, name = '') {
            PhoneState.inCall = { number, name, startedAt: Date.now() };
            PhoneState.recents.unshift({ number, name, time: nowTimeHHMM() });
            Phone_render();
            addNotification('电话', `正在呼叫 ${name || number}…`);
        }
        function Phone_callDial() {
            const n = PhoneState.dial.trim();
            if (!n) return addNotification('电话', '请输入号码');
            Phone_call(n, '');
        }
        function Phone_hangup() {
            PhoneState.inCall = null;
            if (Phone_timer) clearInterval(Phone_timer);
            Phone_timer = null;
            addNotification('电话', '通话已结束（模拟）');
            Phone_render();
        }
        function Phone_updateTimer() {
            if (Phone_timer) clearInterval(Phone_timer);
            const tick = () => {
                const el = document.getElementById('call-timer');
                if (!el || !PhoneState.inCall) return;
                const secs = Math.floor((Date.now() - PhoneState.inCall.startedAt) / 1000);
                const mm = String(Math.floor(secs / 60)).padStart(2, '0');
                const ss = String(secs % 60).padStart(2, '0');
                el.textContent = `${mm}:${ss}`;
            };
            tick();
            Phone_timer = setInterval(tick, 1000);
        }
        function Phone_key(k) {
            PhoneState.dial += k;
            Phone_render();
        }
        function Phone_backspace() {
            PhoneState.dial = PhoneState.dial.slice(0, -1);
            Phone_render();
        }
        function Phone_clear() {
            PhoneState.dial = '';
            Phone_render();
        }
        function Phone_clearRecents() {
            PhoneState.recents = [];
            Phone_render();
        }

        // Messages
        function Messages_render() {
            const body = document.getElementById('messages-body');
            if (!body) return;
            if (AppState.currentChatId) {
                const contact = AppState.contacts.find(x => x.id === AppState.currentChatId);
                const msgs = AppState.messages.filter(m => m.contactId === AppState.currentChatId);
                body.innerHTML = `
                    <div class="h-full flex flex-col">
                        <div class="px-4 py-3 border-b bg-white flex items-center gap-3">
                            <button class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 active:bg-gray-300" onclick="Messages_back()">返回</button>
                            <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-semibold">${contact?.avatar || '?'}</div>
                            <div class="min-w-0">
                                <div class="font-semibold truncate">${contact?.name || '对话'}</div>
                                <div class="text-xs text-gray-500 truncate">${contact?.phone || ''}</div>
                            </div>
                        </div>
                        <div id="chat-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                            ${msgs.length ? msgs.map(m => `
                                <div class="flex ${m.isMe ? 'justify-end' : 'justify-start'}">
                                    <div class="${m.isMe ? 'bg-blue-500 text-white' : 'bg-white text-gray-800'} max-w-[78%] rounded-2xl px-4 py-2 shadow-sm">
                                        <div class="text-[15px] whitespace-pre-wrap break-words">${escapeHtml(m.text)}</div>
                                        <div class="text-[11px] mt-1 ${m.isMe ? 'text-white/80' : 'text-gray-400'}">${m.time}</div>
                                    </div>
                                </div>
                            `).join('') : `<div class="text-center text-gray-500 py-12">暂无消息</div>`}
                        </div>
                        <div class="p-3 bg-white border-t flex items-center gap-2">
                            <input id="chat-input" class="flex-1 px-4 py-3 rounded-2xl border outline-none focus:border-blue-300" placeholder="输入消息…" />
                            <button class="px-4 py-3 rounded-2xl bg-blue-500 text-white hover:opacity-90 active:opacity-70" onclick="Messages_send()">发送</button>
                        </div>
                    </div>
                `;
                setTimeout(() => {
                    const list = document.getElementById('chat-list');
                    if (list) list.scrollTop = list.scrollHeight;
                }, 0);
                return;
            }

            body.innerHTML = `
                ${AppState.contacts.map(contact => {
                    const lastMsg = AppState.messages.filter(m => m.contactId === contact.id).pop();
                    return `
                        <div class="flex items-center p-4 border-b hover:bg-gray-50 active:bg-gray-100" onclick="openChat(${contact.id})">
                            <div class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center text-white font-medium mr-4">${contact.avatar}</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-medium truncate">${contact.name}</span>
                                    <span class="text-xs text-gray-500">${lastMsg ? lastMsg.time : ''}</span>
                                </div>
                                <div class="text-sm text-gray-600 truncate">${lastMsg ? escapeHtml(lastMsg.text) : '暂无消息'}</div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }
        function openChat(contactId) {
            AppState.currentChatId = contactId;
            Messages_render();
        }
        function Messages_back() {
            AppState.currentChatId = null;
            Messages_render();
        }
        function Messages_send() {
            const input = document.getElementById('chat-input');
            const text = (input?.value || '').trim();
            if (!text) return;
            AppState.messages.push({ id: Date.now(), contactId: AppState.currentChatId, text, time: nowTimeHHMM(), isMe: true });
            persist();
            input.value = '';
            Messages_render();
        }

        function escapeHtml(str) {
            return String(str ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        // Browser
        function Browser_normalizeUrl(raw) {
            const s = String(raw || '').trim();
            if (!s) return 'webos://start';
            if (s.startsWith('webos://')) return s;
            if (s.includes('start')) return 'webos://start';
            if (s.includes('wiki')) return 'webos://wiki';
            if (s.includes('files')) return 'webos://files';
            if (s.includes('about')) return 'webos://about';
            if (s.startsWith('http://') || s.startsWith('https://')) return s;
            return 'https://' + s;
        }

        function Browser_navigate(rawUrl) {
            const url = Browser_normalizeUrl(rawUrl);
            AppState.browser.url = url;
            AppState.browser.stack.push(url);
            AppState.browser.stack = AppState.browser.stack.slice(-40);
            AppState.browserHistory.unshift({ url, time: nowTimeHHMM() });
            AppState.browserHistory = AppState.browserHistory.slice(0, 50);
            Browser_render();
        }

        function Browser_render() {
            const input = document.getElementById('browserInput');
            if (input) input.value = AppState.browser.url;
            const goBtn = document.getElementById('browserGo');
            if (input) {
                input.onkeydown = (e) => {
                    if (e.key === 'Enter') Browser_navigate(input.value);
                };
            }
            if (goBtn && input) {
                goBtn.onclick = () => Browser_navigate(input.value);
            }
            const container = document.getElementById('browserPage');
            if (!container) return;

            const url = AppState.browser.url;
            const internal = url.startsWith('webos://');

            if (!internal) {
                container.innerHTML = `
                    <div class="p-4 bg-white rounded-2xl shadow-sm">
                        <div class="font-semibold">外部网页</div>
                        <div class="text-sm text-gray-600 mt-1 break-all">${escapeHtml(url)}</div>
                        <p class="text-sm text-gray-500 mt-3">由于跨域限制，部分站点无法在应用内嵌入显示。</p>
                        <div class="mt-4 flex gap-2">
                            <button class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:opacity-90 active:opacity-70" onclick="window.open('${escapeHtml(url)}','_blank')">在新标签打开</button>
                            <button class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 active:bg-gray-300" onclick="Browser_navigate('webos://start')">返回开始页</button>
                        </div>
                    </div>
                `;
                return;
            }

            const page = Browser_getInternalPage(url);
            container.innerHTML = `
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <div class="px-4 py-3 border-b flex items-center justify-between">
                        <div class="font-semibold">${escapeHtml(page.title)}</div>
                        <div class="text-xs text-gray-500 truncate">${escapeHtml(url)}</div>
                    </div>
                    <div class="p-4 prose prose-sm max-w-none">
                        ${page.html}
                    </div>
                </div>
                <div class="mt-3 bg-white rounded-2xl shadow-sm p-4">
                    <div class="text-sm text-gray-500 mb-2">最近访问</div>
                    <div class="space-y-2">
                        ${(AppState.browserHistory.slice(0, 6)).map(x => `
                            <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-gray-50 active:bg-gray-100" onclick="Browser_navigate('${escapeHtml(x.url)}')">
                                <div class="text-[13px] text-gray-800 truncate">${escapeHtml(x.url)}</div>
                                <div class="text-[11px] text-gray-500">${x.time}</div>
                            </button>
                        `).join('') || `<div class="text-sm text-gray-500">暂无</div>`}
                    </div>
                </div>
            `;
        }

        function Browser_getInternalPage(url) {
            if (url === 'webos://wiki') {
                return {
                    title: '离线 Wiki（Demo）',
                    html: `
                        <h3>什么是 WebOS？</h3>
                        <p>这是一个在浏览器中模拟“移动操作系统”的 Demo：应用、状态栏、统一文件系统与基本交互。</p>
                        <h3>如何验收？</h3>
                        <ol>
                          <li>打开“文件”新建/删除文件或文件夹</li>
                          <li>打开“文本编辑器”编辑并保存文件</li>
                          <li>打开“相机”拍照并在“照片”里预览</li>
                        </ol>
                        <p><button class="px-4 py-2 rounded-xl bg-blue-600 text-white" onclick="openApp('files')">去文件</button></p>
                    `
                };
            }
            if (url === 'webos://files') {
                return {
                    title: '文件系统说明',
                    html: `
                        <p>本系统包含统一文件系统（内存 + localStorage 持久化）。</p>
                        <ul>
                          <li><code>/Documents</code>：文本文件</li>
                          <li><code>/Pictures</code>：相机照片（dataURL）</li>
                          <li><code>/Downloads</code>：示例下载</li>
                        </ul>
                        <p>你也可以在浏览器中打开下载的 <code>demo.html</code>（离线）。</p>
                    `
                };
            }
            if (url === 'webos://about') {
                return {
                    title: '关于',
                    html: `
                        <p>Android 移动端 WebOS 仿真系统（CDN 单文件）。</p>
                        <p>重点：统一文件系统、多款核心应用、交互反馈与视觉一致性。</p>
                    `
                };
            }
            return {
                title: '开始页',
                html: `
                    <p>在地址栏输入：</p>
                    <ul>
                      <li><code>webos://wiki</code> 查看离线示例页</li>
                      <li><code>webos://files</code> 查看文件系统说明</li>
                      <li>也可输入任意 https 网址并在新标签打开</li>
                    </ul>
                    <p class="mt-3"><button class="px-4 py-2 rounded-xl bg-blue-600 text-white" onclick="openApp('camera')">打开相机</button></p>
                `
            };
        }

        // Files
        function Files_go(path) {
            const p = normalizePath(path);
            const node = fsGetNode(p);
            if (!node || node.type !== 'dir') {
                addNotification('文件', '目录不存在');
                return;
            }
            AppState.files.cwd = p;
            Files_refresh();
        }
        function Files_up() {
            const p = normalizePath(AppState.files.cwd);
            if (p === '/') return;
            const parts = splitPath(p);
            parts.pop();
            Files_go('/' + parts.join('/'));
        }
        function Files_refresh() {
            const pathEl = document.getElementById('files-path');
            if (pathEl) pathEl.textContent = AppState.files.cwd;
            const listEl = document.getElementById('files-list');
            if (!listEl) return;
            const entries = fsListDir(AppState.files.cwd)
                .sort((a, b) => (a.node.type === b.node.type ? a.name.localeCompare(b.name) : a.node.type === 'dir' ? -1 : 1));
            listEl.innerHTML = entries.length ? entries.map(({ name, node }) => {
                const full = normalizePath(AppState.files.cwd + '/' + name);
                const isDir = node.type === 'dir';
                const mime = node.mime || fsGuessMime(name);
                const isImg = isImageMime(mime);
                return `
                    <div class="flex items-center gap-3 p-4 border-b hover:bg-gray-50 active:bg-gray-100">
                        <div class="w-11 h-11 rounded-2xl ${isDir ? 'bg-yellow-50 text-yellow-600' : isImg ? 'bg-pink-50 text-pink-600' : 'bg-gray-100 text-gray-600'} flex items-center justify-center">
                            ${isDir ? folderIcon() : isImg ? photoIcon() : fileIcon()}
                        </div>
                        <button class="flex-1 min-w-0 text-left" onclick="${isDir ? `Files_go('${escapeHtml(full)}')` : `Files_open('${escapeHtml(full)}')`}">
                            <div class="font-medium truncate">${escapeHtml(name)}</div>
                            <div class="text-xs text-gray-500 truncate">${isDir ? '文件夹' : (mime || '文件')}</div>
                        </button>
                        <button class="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 active:bg-gray-300" onclick="Files_delete('${escapeHtml(full)}')">删除</button>
                    </div>
                `;
            }).join('') : `<div class="p-10 text-center text-gray-500">空文件夹</div>`;
        }
        function Files_newFolder() {
            const name = prompt('新建文件夹名称');
            if (!name) return;
            const safe = name.trim().replaceAll('/', '_');
            const full = normalizePath(AppState.files.cwd + '/' + safe);
            if (!fsCreateDir(full)) return addNotification('文件', '创建失败（可能已存在）');
            addNotification('文件', `已创建 ${full}`);
            Files_refresh();
        }
        function Files_newFile() {
            const name = prompt('新建文件名称（例如 hello.txt）', 'new.txt');
            if (!name) return;
            const safe = name.trim().replaceAll('/', '_');
            const full = normalizePath(AppState.files.cwd + '/' + safe);
            const ok = fsWriteFile(full, '', fsGuessMime(safe));
            if (!ok) return addNotification('文件', '创建失败');
            addNotification('文件', `已创建 ${full}`);
            Files_refresh();
        }
        function Files_delete(path) {
            if (!confirm(`删除：${path} ？`)) return;
            if (!fsDelete(path)) return addNotification('文件', '删除失败');
            if (AppState.photoViewer.path === path) AppState.photoViewer.path = null;
            addNotification('文件', `已删除 ${path}`);
            Files_refresh();
        }
        function Files_open(path) {
            const node = fsGetNode(path);
            if (!node || node.type !== 'file') return;
            const mime = node.mime || fsGuessMime(path);
            if (isImageMime(mime)) {
                openApp('photos');
                setTimeout(() => Photos_open(path), 0);
                return;
            }
            openApp('editor');
            setTimeout(() => Editor_open(path), 0);
        }

        function folderIcon() {
            return `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>`;
        }
        function fileIcon() {
            return `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h7l3 3v11a2 2 0 01-2 2H7a2 2 0 01-2-2V9a2 2 0 012-2z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 7v4h4"/></svg>`;
        }
        function photoIcon() {
            return `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>`;
        }

        // Photos
        function Photos_refresh() {
            const grid = document.getElementById('photos-grid');
            const empty = document.getElementById('photos-empty');
            const viewer = document.getElementById('photo-viewer');
            if (!grid || !empty || !viewer) return;
            const pics = fsListDir('/Pictures')
                .filter(x => x.node.type === 'file' && isImageMime(x.node.mime || fsGuessMime(x.name)))
                .sort((a, b) => b.name.localeCompare(a.name));

            if (!pics.length) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                grid.innerHTML = pics.map(({ name, node }) => {
                    const path = `/Pictures/${name}`;
                    const src = node.content;
                    return `
                        <button class="aspect-square rounded-xl overflow-hidden bg-gray-100 border hover:opacity-90 active:opacity-70" onclick="Photos_open('${escapeHtml(path)}')">
                            <img alt="${escapeHtml(name)}" src="${escapeHtml(src)}" class="w-full h-full object-cover" />
                        </button>
                    `;
                }).join('');
            }

            if (AppState.photoViewer.path) {
                Photos_open(AppState.photoViewer.path);
            } else {
                viewer.classList.add('hidden');
            }
        }

        function Photos_open(path) {
            const node = fsGetNode(path);
            if (!node || node.type !== 'file') return;
            AppState.photoViewer.path = path;
            const viewer = document.getElementById('photo-viewer');
            const img = document.getElementById('photo-viewer-img');
            const nameEl = document.getElementById('photo-viewer-name');
            if (!viewer || !img || !nameEl) return;
            viewer.classList.remove('hidden');
            img.src = node.content;
            nameEl.textContent = path.split('/').pop();
        }
        function Photos_closeViewer() {
            AppState.photoViewer.path = null;
            const viewer = document.getElementById('photo-viewer');
            if (viewer) viewer.classList.add('hidden');
        }
        function Photos_deleteCurrent() {
            const path = AppState.photoViewer.path;
            if (!path) return;
            if (!confirm('删除当前照片？')) return;
            const ok = fsDelete(path);
            if (ok) addNotification('照片', '已删除');
            Photos_closeViewer();
            Photos_refresh();
        }

        // Editor
        function Editor_init() {
            const textarea = document.getElementById('editor-textarea');
            const pathEl = document.getElementById('editor-path');
            const saveBtn = document.getElementById('editor-save');
            if (!textarea || !pathEl || !saveBtn) return;

            const existing = fsGetNode(AppState.editor.path);
            if (!existing || existing.type !== 'file') {
                fsEnsureDir('/Documents');
                fsWriteFile('/Documents/notes.txt', fsReadFile('/Documents/notes.txt') || '', 'text/plain');
                AppState.editor.path = '/Documents/notes.txt';
            }

            AppState.editor.draft = fsReadFile(AppState.editor.path) ?? '';
            AppState.editor.dirty = false;
            pathEl.textContent = AppState.editor.path;
            textarea.value = AppState.editor.draft;

            textarea.addEventListener('input', () => {
                AppState.editor.draft = textarea.value;
                AppState.editor.dirty = true;
            });
            saveBtn.addEventListener('click', () => Editor_save());
        }
        function Editor_open(path) {
            const p = normalizePath(path);
            const node = fsGetNode(p);
            if (!node || node.type !== 'file') return addNotification('文本编辑器', '文件不存在');
            AppState.editor.path = p;
            AppState.editor.draft = fsReadFile(p) ?? '';
            AppState.editor.dirty = false;
            const textarea = document.getElementById('editor-textarea');
            const pathEl = document.getElementById('editor-path');
            if (textarea) textarea.value = AppState.editor.draft;
            if (pathEl) pathEl.textContent = AppState.editor.path;
            addNotification('文本编辑器', `已打开 ${p}`);
        }
        function Editor_save() {
            const p = normalizePath(AppState.editor.path);
            const ok = fsWriteFile(p, AppState.editor.draft, fsGuessMime(p));
            if (!ok) return addNotification('文本编辑器', '保存失败');
            AppState.editor.dirty = false;
            addNotification('文本编辑器', `已保存 ${p}`);
        }
        function Editor_saveAs() {
            const name = prompt('另存为文件名', AppState.editor.path.split('/').pop() || 'new.txt');
            if (!name) return;
            const safe = name.trim().replaceAll('/', '_');
            const target = normalizePath('/Documents/' + safe);
            const ok = fsWriteFile(target, AppState.editor.draft, fsGuessMime(safe));
            if (!ok) return addNotification('文本编辑器', '另存为失败');
            AppState.editor.path = target;
            AppState.editor.dirty = false;
            const pathEl = document.getElementById('editor-path');
            if (pathEl) pathEl.textContent = AppState.editor.path;
            addNotification('文本编辑器', `已保存到 ${target}`);
        }
        function Editor_newFile() {
            const name = prompt('新建文件名', 'untitled.txt');
            if (!name) return;
            const safe = name.trim().replaceAll('/', '_');
            const target = normalizePath('/Documents/' + safe);
            const ok = fsWriteFile(target, '', fsGuessMime(safe));
            if (!ok) return addNotification('文本编辑器', '创建失败');
            openApp('editor');
            setTimeout(() => Editor_open(target), 0);
        }
        function Editor_pickFile() {
            openApp('files');
            AppState.files.cwd = '/Documents';
            setTimeout(() => Files_refresh(), 0);
        }

        // Mail
        function Mail_render() {
            const body = document.getElementById('mail-body');
            if (!body) return;
            if (AppState.currentEmailId) {
                const mail = AppState.emails.find(x => x.id === AppState.currentEmailId);
                body.innerHTML = `
                    <div class="p-4">
                        <button class="px-3 py-2 rounded-xl bg-white border hover:bg-gray-50 active:bg-gray-100" onclick="Mail_back()">返回</button>
                        <div class="mt-4 bg-white rounded-2xl border p-4">
                            <div class="text-sm text-gray-500">发件人</div>
                            <div class="font-medium break-all">${escapeHtml(mail?.from || '—')}</div>
                            <div class="mt-3 text-sm text-gray-500">主题</div>
                            <div class="font-semibold">${escapeHtml(mail?.subject || '—')}</div>
                            <div class="mt-3 text-sm text-gray-500">时间</div>
                            <div class="text-sm">${escapeHtml(mail?.time || '—')}</div>
                            <div class="mt-4 whitespace-pre-wrap text-[15px] leading-relaxed">${escapeHtml(mail?.body || '')}</div>
                        </div>
                    </div>
                `;
                return;
            }
            body.innerHTML = `
                <div class="p-4 space-y-3">
                    ${AppState.emails.map(m => `
                        <button class="w-full text-left bg-white rounded-2xl border p-4 hover:bg-gray-50 active:bg-gray-100" onclick="Mail_open(${m.id})">
                            <div class="flex items-center justify-between gap-3">
                                <div class="font-medium truncate">${escapeHtml(m.subject)}</div>
                                <div class="text-xs text-gray-500">${escapeHtml(m.time)}</div>
                            </div>
                            <div class="text-sm text-gray-600 mt-1 truncate">${escapeHtml(m.from)}</div>
                        </button>
                    `).join('')}
                </div>
            `;
        }
        function Mail_open(id) {
            AppState.currentEmailId = id;
            Mail_render();
        }
        function Mail_back() {
            AppState.currentEmailId = null;
            Mail_render();
        }

        // Recents
        function Recents_show() {
            if (!AppState.recents.length) return addNotification('最近任务', '暂无已打开应用');
            const names = AppState.recents.slice(0, 6).map(x => Apps[x.appId]?.name || x.appId).join('、');
            addNotification('最近任务', names);
        }

        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
