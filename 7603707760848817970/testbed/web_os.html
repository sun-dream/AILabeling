<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebOS - AI Generated</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'os-bg': '#0f172a',
                        'win-bg': 'rgba(255, 255, 255, 0.95)',
                        'win-dark': 'rgba(30, 41, 59, 0.95)',
                    },
                    backdropBlur: {
                        xs: '2px',
                    }
                }
            }
        }
    </script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; user-select: none; }
        input, textarea, [contenteditable="true"] { user-select: text; }

        .win-control-btn {
            width: 44px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #111827;
            border-radius: 6px;
        }
        .win-control-btn:hover { background: rgba(15, 23, 42, 0.08); }
        .win-control-btn:active { background: rgba(15, 23, 42, 0.14); }
        .win-control-btn.close:hover { background: #e81123; color: white; }
        .win-control-btn.close:active { background: #c50f1f; color: white; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .desktop-icon {
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        
        .window {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s, opacity 0.1s;
        }

        .window.maximizing {
            transition: all 0.2s ease-in-out;
        }

        .taskbar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #boot-screen {
            z-index: 9999;
        }

        /* CRT Effect for Terminal */
        .terminal-font {
            font-family: 'Courier New', Courier, monospace;
        }

        .crt::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen w-screen overflow-hidden">

    <!-- Boot Screen -->
    <div id="boot-screen" class="absolute inset-0 bg-black flex flex-col items-center justify-center text-white">
        <div class="mb-4">
            <i class="fa-brands fa-windows text-6xl text-blue-500 animate-pulse"></i>
        </div>
        <div class="w-64 h-2 bg-gray-800 rounded-full overflow-hidden">
            <div id="boot-progress" class="h-full bg-blue-500 w-0 transition-all duration-[2000ms]"></div>
        </div>
        <div class="mt-4 text-gray-400 text-sm font-mono">Initializing WebOS System...</div>
    </div>

    <!-- Desktop Environment -->
    <div id="desktop" class="absolute inset-0 bg-cover bg-center hidden" style="background-image: url('https://aidp.juejin.cn/agentic/api/v1/tool/text2image?prompt=abstract%20modern%20windows%2011%20style%20wallpaper%20blue%20purple%20fluid%20gradient%203d%20shapes%20minimalist&size=1600x900');">
        
        <!-- Desktop Icons Container -->
        <div id="desktop-icons" class="absolute top-0 left-0 right-0 bottom-12 p-2">
            <!-- Icons injected by JS -->
        </div>

        <!-- Window Container -->
        <div id="window-area" class="absolute inset-0 pointer-events-none">
            <!-- Windows injected by JS -->
        </div>

        <!-- Start Menu -->
        <div id="start-menu" class="absolute bottom-14 left-4 w-[600px] h-[500px] glass-dark rounded-xl shadow-2xl flex flex-col hidden transition-all duration-200 transform origin-bottom-left scale-95 opacity-0 text-white border border-gray-700 z-[1000]">
            <div class="p-6">
                <input type="text" placeholder="Type here to search..." class="w-full bg-gray-800 border border-gray-700 rounded-md px-4 py-2 text-sm focus:outline-none focus:border-blue-500">
            </div>
            <div class="flex-1 overflow-y-auto px-6 pb-6">
                <div class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">Pinned</div>
                <div class="grid grid-cols-6 gap-4" id="start-menu-grid">
                    <!-- Apps injected here -->
                </div>
            </div>
            <div class="p-4 bg-gray-800/50 border-t border-gray-700 flex justify-between items-center rounded-b-xl">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold">U</div>
                    <span class="text-sm font-medium">User</span>
                </div>
                <button onclick="location.reload()" class="p-2 hover:bg-gray-700 rounded-md transition-colors">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>
        </div>

        <!-- Context Menu (Right Click) -->
        <div id="context-menu" class="fixed bg-gray-800 border border-gray-700 shadow-xl rounded-md py-1 w-48 hidden z-[2000] text-sm">
            <div class="hover:bg-blue-600 px-4 py-2 cursor-pointer" onclick="FileSystem.createFile(ContextMenu.targetPath, 'New Text Document.txt', '')">New Text Document</div>
            <div class="hover:bg-blue-600 px-4 py-2 cursor-pointer" onclick="FileSystem.createFolder(ContextMenu.targetPath, 'New Folder')">New Folder</div>
            <div class="border-t border-gray-700 my-1"></div>
            <div class="hover:bg-blue-600 px-4 py-2 cursor-pointer" onclick="WindowManager.refreshDesktop()">Refresh</div>
        </div>

        <!-- Taskbar -->
        <div id="taskbar" class="absolute bottom-0 left-0 right-0 h-12 glass-dark flex items-center px-4 justify-between z-[1000]">
            <div class="flex items-center gap-2 h-full">
                <!-- Start Button -->
                <button id="start-btn" class="p-2 rounded hover:bg-white/10 transition-colors mr-2">
                    <i class="fa-brands fa-windows text-blue-400 text-xl"></i>
                </button>
                
                <!-- Pinned/Active Apps -->
                <div id="taskbar-apps" class="flex gap-1 h-full py-1">
                    <!-- Injected by JS -->
                </div>
            </div>

            <!-- System Tray -->
            <div class="flex items-center gap-4 text-xs px-2 h-full hover:bg-white/5 rounded transition-colors cursor-pointer" onclick="WindowManager.open('calendar')">
                <i class="fa-solid fa-wifi"></i>
                <i class="fa-solid fa-volume-high"></i>
                <div class="text-right">
                    <div id="clock-time" class="font-medium">12:00 PM</div>
                    <div id="clock-date" class="text-gray-400 text-[10px]">10/24/2023</div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Logic -->
    <script>
        // --- Utils ---
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => document.querySelectorAll(sel);
        const uuid = () => Math.random().toString(36).substring(2) + Date.now().toString(36);

        // --- Dialogs (No native alert/confirm/prompt) ---
        const Dialog = {
            _ensure() {
                if ($('#webos-dialog-overlay')) return;
                const overlay = document.createElement('div');
                overlay.id = 'webos-dialog-overlay';
                overlay.className = 'fixed inset-0 hidden items-center justify-center z-[4000]';
                overlay.innerHTML = `
                    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
                    <div class="relative w-[520px] max-w-[calc(100vw-32px)] rounded-xl bg-white shadow-2xl border border-gray-200 overflow-hidden">
                        <div class="h-10 flex items-center justify-between pl-4 pr-2 bg-white/80 backdrop-blur border-b border-gray-200 select-none">
                            <div class="flex items-center gap-2 text-sm font-semibold text-gray-800">
                                <i class="fa-brands fa-windows text-blue-600"></i>
                                <span id="webos-dialog-title">WebOS</span>
                            </div>
                            <button class="win-control-btn close" id="webos-dialog-x" aria-label="Close">
                                <i class="fa-solid fa-xmark text-[14px]"></i>
                            </button>
                        </div>
                        <div class="p-4 text-gray-800">
                            <div id="webos-dialog-message" class="text-sm leading-relaxed whitespace-pre-wrap"></div>
                            <div id="webos-dialog-input-wrap" class="mt-3 hidden">
                                <input id="webos-dialog-input" class="w-full border rounded-lg px-3 py-2 text-sm bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-400" />
                            </div>
                        </div>
                        <div class="p-3 bg-gray-50 border-t border-gray-200 flex justify-end gap-2">
                            <button id="webos-dialog-cancel" class="px-4 py-2 rounded-lg text-sm border bg-white hover:bg-gray-50 text-gray-800">Cancel</button>
                            <button id="webos-dialog-ok" class="px-4 py-2 rounded-lg text-sm bg-blue-600 hover:bg-blue-700 text-white">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
            },
            _open({ title, message, mode, defaultValue, placeholder, okText, cancelText }) {
                this._ensure();
                const overlay = $('#webos-dialog-overlay');
                const titleEl = $('#webos-dialog-title');
                const msgEl = $('#webos-dialog-message');
                const inputWrap = $('#webos-dialog-input-wrap');
                const inputEl = $('#webos-dialog-input');
                const okBtn = $('#webos-dialog-ok');
                const cancelBtn = $('#webos-dialog-cancel');
                const xBtn = $('#webos-dialog-x');

                titleEl.textContent = title || 'WebOS';
                msgEl.textContent = message || '';
                okBtn.textContent = okText || 'OK';
                cancelBtn.textContent = cancelText || 'Cancel';

                const isPrompt = mode === 'prompt';
                const isConfirm = mode === 'confirm';
                const isAlert = mode === 'alert';

                inputWrap.classList.toggle('hidden', !isPrompt);
                cancelBtn.classList.toggle('hidden', isAlert);

                if (isPrompt) {
                    inputEl.value = defaultValue ?? '';
                    inputEl.placeholder = placeholder ?? '';
                }

                overlay.classList.remove('hidden');
                overlay.classList.add('flex');

                const cleanup = () => {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    xBtn.onclick = null;
                    overlay.onmousedown = null;
                    inputEl.onkeydown = null;
                };

                return new Promise((resolve) => {
                    const closeAs = (v) => { cleanup(); resolve(v); };

                    okBtn.onclick = () => {
                        if (isPrompt) return closeAs(String(inputEl.value ?? ''));
                        if (isConfirm) return closeAs(true);
                        return closeAs(true);
                    };
                    cancelBtn.onclick = () => closeAs(isPrompt ? null : false);
                    xBtn.onclick = () => closeAs(isPrompt ? null : false);

                    overlay.onmousedown = (e) => {
                        if (e.target === overlay) closeAs(isPrompt ? null : false);
                    };

                    inputEl.onkeydown = (e) => {
                        if (!isPrompt) return;
                        if (e.key === 'Enter') okBtn.click();
                        if (e.key === 'Escape') closeAs(null);
                    };

                    requestAnimationFrame(() => {
                        if (isPrompt) inputEl.focus();
                        else okBtn.focus();
                    });
                });
            },
            alert(message, opts = {}) {
                return this._open({ title: opts.title, message, mode: 'alert', okText: opts.okText });
            },
            confirm(message, opts = {}) {
                return this._open({ title: opts.title, message, mode: 'confirm', okText: opts.okText, cancelText: opts.cancelText });
            },
            prompt(message, opts = {}) {
                return this._open({
                    title: opts.title,
                    message,
                    mode: 'prompt',
                    defaultValue: opts.defaultValue,
                    placeholder: opts.placeholder,
                    okText: opts.okText,
                    cancelText: opts.cancelText
                });
            }
        };

        // --- File System (VFS) ---
        class VFS {
            constructor() {
                this.root = this.load() || this.createDefaultStructure();
            }

            createDefaultStructure() {
                return {
                    "type": "dir",
                    "name": "root",
                    "children": {
                        "Desktop": {
                            "type": "dir", "children": {
                                "Welcome.txt": { "type": "file", "content": "Welcome to WebOS!\n\nThis is a fully functional web-based operating system.\nTry opening the Terminal and running Python code!" },
                                "Projects": { "type": "dir", "children": {} }
                            }
                        },
                        "Documents": {
                            "type": "dir", "children": {
                                "notes.txt": { "type": "file", "content": "Buy milk\nWalk the dog" }
                            }
                        },
                        "Downloads": { "type": "dir", "children": {} },
                        "Pictures": { 
                            "type": "dir", "children": {
                                "mountains.jpg": { "type": "file", "content": "https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&w=800&q=80" },
                                "ocean.jpg": { "type": "file", "content": "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=800&q=80" },
                                "city.jpg": { "type": "file", "content": "https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?auto=format&fit=crop&w=800&q=80" }
                            } 
                        }
                    }
                };
            }

            load() {
                const saved = localStorage.getItem('webos_vfs');
                return saved ? JSON.parse(saved) : null;
            }

            save() {
                localStorage.setItem('webos_vfs', JSON.stringify(this.root));
                WindowManager.refreshDesktop();
            }

            resolve(path) {
                const parts = path.split('/').filter(p => p);
                let current = this.root;
                for (const part of parts) {
                    if (current.type !== 'dir' || !current.children[part]) return null;
                    current = current.children[part];
                }
                return current;
            }

            getParent(path) {
                const parts = path.split('/').filter(p => p);
                parts.pop();
                return this.resolve(parts.join('/'));
            }

            // CRUD
            writeFile(path, content) {
                const parts = path.split('/').filter(p => p);
                const fileName = parts.pop();
                const parent = this.resolve(parts.join('/'));
                if (parent && parent.type === 'dir') {
                    parent.children[fileName] = { type: 'file', content: content };
                    this.save();
                    return true;
                }
                return false;
            }
            
            createFile(path, name, content) {
                const dir = this.resolve(path);
                if(dir && dir.type === 'dir') {
                    if (dir.children[name]) return false;
                    dir.children[name] = { type: 'file', content: content };
                    this.save();
                    if(path === '/Desktop') WindowManager.refreshDesktop();
                    // If current explorer is viewing this path, refresh it? 
                    // Need pub/sub ideally, but simple reload works for desktop
                    return true;
                }
                return false;
            }
            
            createFolder(path, name) {
                const dir = this.resolve(path);
                if(dir && dir.type === 'dir') {
                    if (dir.children[name]) return false;
                    dir.children[name] = { type: 'dir', children: {} };
                    this.save();
                    if(path === '/Desktop') WindowManager.refreshDesktop();
                    return true;
                }
                return false;
            }

            mkdir(path) {
                const parts = path.split('/').filter(p => p);
                const dirName = parts.pop();
                const parent = this.resolve(parts.join('/'));
                if (parent && parent.type === 'dir') {
                    if (!parent.children[dirName]) {
                        parent.children[dirName] = { type: 'dir', children: {} };
                        this.save();
                        return true;
                    }
                }
                return false;
            }

            delete(path) {
                const parts = path.split('/').filter(p => p);
                if (parts.length === 0) return false;
                const name = parts.pop();
                const parent = this.resolve(parts.join('/'));
                if (parent && parent.children[name]) {
                    delete parent.children[name];
                    this.save();
                    return true;
                }
                return false;
            }

            rename(path, newName) {
                const parts = path.split('/').filter(p => p);
                if (parts.length === 0) return false;
                const oldName = parts.pop();
                const parent = this.resolve(parts.join('/'));
                if (!parent || parent.type !== 'dir') return false;
                if (!parent.children[oldName]) return false;
                if (!newName || typeof newName !== 'string') return false;
                const trimmed = newName.trim();
                if (!trimmed || trimmed.includes('/')) return false;
                if (parent.children[trimmed] && trimmed !== oldName) return false;
                if (trimmed === oldName) return true;
                parent.children[trimmed] = parent.children[oldName];
                delete parent.children[oldName];
                this.save();
                return true;
            }
        }

        const FileSystem = new VFS();

        // --- App Registry ---
        const Apps = {
            'notepad': {
                name: 'Notepad',
                icon: 'fa-regular fa-file-lines',
                color: 'text-blue-400',
                render: (win, path) => new NotepadApp(win, path)
            },
            'terminal': {
                name: 'Terminal',
                icon: 'fa-solid fa-terminal',
                color: 'text-gray-200',
                render: (win) => new TerminalApp(win)
            },
            'vscode': {
                name: 'Code Editor',
                icon: 'fa-solid fa-code',
                color: 'text-blue-500',
                render: (win, path) => new CodeApp(win, path)
            },
            'browser': {
                name: 'Browser',
                icon: 'fa-brands fa-chrome',
                color: 'text-green-500',
                render: (win) => new BrowserApp(win)
            },
            'photos': {
                name: 'Photos',
                icon: 'fa-regular fa-image',
                color: 'text-purple-500',
                render: (win, path) => new PhotoViewerApp(win, path)
            },
            'paint': {
                name: 'Paint',
                icon: 'fa-solid fa-paintbrush',
                color: 'text-pink-500',
                render: (win) => new PaintApp(win)
            },
            'calculator': {
                name: 'Calculator',
                icon: 'fa-solid fa-calculator',
                color: 'text-orange-500',
                render: (win) => new CalculatorApp(win)
            },
            'calendar': {
                name: 'Calendar',
                icon: 'fa-regular fa-calendar',
                color: 'text-blue-500',
                render: (win) => new CalendarApp(win)
            },
            'snake': {
                name: 'Snake Game',
                icon: 'fa-solid fa-gamepad',
                color: 'text-purple-500',
                render: (win) => new SnakeApp(win)
            },
            'video': {
                name: 'Video Player',
                icon: 'fa-solid fa-film',
                color: 'text-red-500',
                render: (win) => new VideoApp(win)
            },
            'settings': {
                name: 'Settings',
                icon: 'fa-solid fa-gear',
                color: 'text-gray-400',
                render: (win) => new SettingsApp(win)
            }
        };

        // --- Window Manager ---
        class WM {
            constructor() {
                this.windows = [];
                this.activeWindowId = null;
                this.zIndexCounter = 100;
                this.container = $('#window-area');
                this.taskbar = $('#taskbar-apps');
                this.pinnedApps = ['explorer', 'terminal', 'browser', 'notepad', 'vscode'];
            }

            open(appId, args = null) {
                const id = uuid();
                const appConfig = Apps[appId];
                
                const winEl = document.createElement('div');
                winEl.className = 'window absolute bg-white rounded-lg overflow-hidden flex flex-col pointer-events-auto border border-gray-600/20';
                winEl.style.width = '800px';
                winEl.style.height = '600px';
                winEl.style.left = (100 + (this.windows.length * 20)) + 'px';
                winEl.style.top = (50 + (this.windows.length * 20)) + 'px';
                winEl.style.zIndex = ++this.zIndexCounter;
                winEl.id = `win-${id}`;

                // Header
                winEl.innerHTML = `
                    <div class="window-header h-10 bg-white/80 backdrop-blur-md border-b border-gray-200 flex items-center justify-between pl-3 pr-1 select-none" ondblclick="WindowManager.toggleMaximize('${id}')">
                        <div class="flex items-center gap-2 text-sm font-semibold text-gray-800">
                            <i class="${appConfig.icon} ${appConfig.color}"></i>
                            <span>${appConfig.name}</span>
                        </div>
                        <div class="flex items-center">
                            <button class="win-control-btn" onclick="WindowManager.minimize('${id}')" aria-label="Minimize">
                                <i class="fa-solid fa-window-minimize text-[12px] relative top-[-4px]"></i>
                            </button>
                            <button class="win-control-btn" onclick="WindowManager.toggleMaximize('${id}')" aria-label="Maximize or Restore">
                                <i class="fa-regular fa-square text-[12px]"></i>
                            </button>
                            <button class="win-control-btn close" onclick="WindowManager.close('${id}')" aria-label="Close">
                                <i class="fa-solid fa-xmark text-[14px]"></i>
                            </button>
                        </div>
                    </div>
                    <div class="window-content flex-1 bg-white relative overflow-hidden text-gray-900"></div>
                    <div class="resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-se-resize z-50"></div>
                `;

                this.container.appendChild(winEl);
                
                // Initialize App
                const contentArea = winEl.querySelector('.window-content');
                contentArea.dataset.winId = id;
                let appInstance = null;
                try {
                    const safeArgs = args === null ? undefined : args;
                    appInstance = safeArgs === undefined ? appConfig.render(contentArea) : appConfig.render(contentArea, safeArgs);
                } catch (e) {
                    winEl.remove();
                    Dialog.alert(String(e?.message || e), { title: `${appConfig?.name || 'App'} Error` });
                    return;
                }

                const winObj = { id, appId, element: winEl, app: appInstance, minimized: false, maximized: false };
                this.windows.push(winObj);
                
                this.setupDrag(winEl, id);
                this.setupResize(winEl);
                this.focus(id);
                this.renderTaskbar();
                winEl.addEventListener('mousedown', () => this.focus(id));

                // Animation
                winEl.style.transform = 'scale(0.95)';
                winEl.style.opacity = '0';
                requestAnimationFrame(() => {
                    winEl.style.transform = 'scale(1)';
                    winEl.style.opacity = '1';
                });
            }

            close(id) {
                const winObj = this.windows.find(w => w.id === id);
                if (winObj) {
                    winObj.element.remove();
                    this.windows = this.windows.filter(w => w.id !== id);
                    this.renderTaskbar();
                }
            }

            minimize(id) {
                const win = this.windows.find(w => w.id === id);
                if (!win) return;
                win.minimized = true;
                win.element.style.display = 'none';
                this.renderTaskbar();
            }

            restore(id) {
                const win = this.windows.find(w => w.id === id);
                if (!win) return;
                win.minimized = false;
                win.element.style.display = 'flex';
                this.focus(id);
                this.renderTaskbar();
            }

            toggleMaximize(id) {
                const win = this.windows.find(w => w.id === id);
                if (!win) return;
                if (win.maximized) {
                    win.element.setAttribute('style', win.preMaxStyle || '');
                    win.maximized = false;
                    win.element.classList.remove('maximizing');
                } else {
                    win.preMaxStyle = win.element.getAttribute('style');
                    win.element.style.top = '0';
                    win.element.style.left = '0';
                    win.element.style.width = '100%';
                    win.element.style.height = 'calc(100% - 48px)'; // minus taskbar
                    win.element.style.transform = 'none';
                    win.element.style.zIndex = ++this.zIndexCounter;
                    win.maximized = true;
                    win.element.classList.add('maximizing');
                }
            }

            focus(id) {
                const win = this.windows.find(w => w.id === id);
                if (win) {
                    win.element.style.zIndex = ++this.zIndexCounter;
                    this.activeWindowId = id;
                    this.renderTaskbar();
                    // Highlight header
                    $$('.window-header').forEach(h => h.classList.replace('bg-blue-100', 'bg-gray-100'));
                    // win.element.querySelector('.window-header').classList.replace('bg-gray-100', 'bg-blue-100');
                }
            }

            setupDrag(el, id) {
                const header = el.querySelector('.window-header');
                let isDragging = false;
                let startX, startY, initialLeft, initialTop;

                header.addEventListener('mousedown', (e) => {
                    if (e.target.closest && e.target.closest('button')) return;
                    this.focus(id);
                    const win = this.windows.find(w => w.id === id);
                    if (win.maximized) return;

                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialLeft = el.offsetLeft;
                    initialTop = el.offsetTop;
                });

                window.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    el.style.left = `${initialLeft + dx}px`;
                    el.style.top = `${initialTop + dy}px`;
                });

                window.addEventListener('mouseup', () => isDragging = false);
            }

            setupResize(el) {
                const handle = el.querySelector('.resize-handle');
                let isResizing = false;
                
                handle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    e.stopPropagation();
                });

                window.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;
                    el.style.width = (e.clientX - el.offsetLeft) + 'px';
                    el.style.height = (e.clientY - el.offsetTop) + 'px';
                });
                
                window.addEventListener('mouseup', () => isResizing = false);
            }

            renderTaskbar() {
                this.taskbar.innerHTML = '';
                const pinned = this.pinnedApps.filter(id => Apps[id]);
                pinned.forEach(appId => {
                    const app = Apps[appId];
                    const win = this.windows.find(w => w.appId === appId);
                    const isActive = win && win.id === this.activeWindowId && !win.minimized;
                    const el = document.createElement('div');
                    el.className = `h-full aspect-square flex items-center justify-center rounded cursor-pointer transition-all ${isActive ? 'bg-white/20 border-b-2 border-blue-400' : 'hover:bg-white/10'}`;
                    el.onclick = () => {
                        if (!win) return this.open(appId);
                        return win.minimized || win.id !== this.activeWindowId ? this.restore(win.id) : this.minimize(win.id);
                    };
                    el.innerHTML = `<i class="${app.icon} ${app.color} text-xl"></i>`;
                    this.taskbar.appendChild(el);
                });

                const unpinnedWindows = this.windows.filter(w => !pinned.includes(w.appId));
                if (unpinnedWindows.length) {
                    const sep = document.createElement('div');
                    sep.className = 'w-px h-7 bg-white/10 mx-1 self-center';
                    this.taskbar.appendChild(sep);
                }

                unpinnedWindows.forEach(win => {
                    const app = Apps[win.appId];
                    const isActive = win.id === this.activeWindowId && !win.minimized;
                    const el = document.createElement('div');
                    el.className = `h-full aspect-square flex items-center justify-center rounded cursor-pointer transition-all ${isActive ? 'bg-white/20 border-b-2 border-blue-400' : 'hover:bg-white/10'}`;
                    el.onclick = () => win.minimized || win.id !== this.activeWindowId ? this.restore(win.id) : this.minimize(win.id);
                    el.innerHTML = `<i class="${app.icon} ${app.color} text-xl"></i>`;
                    this.taskbar.appendChild(el);
                });
            }
            
            refreshDesktop() {
                const container = $('#desktop-icons');
                container.innerHTML = '';
                container.style.position = 'absolute';
                container.style.left = '0';
                container.style.top = '0';
                container.style.right = '0';
                container.style.bottom = '48px';
                container.style.padding = '8px';

                const shortcuts = ['explorer', 'notepad', 'terminal', 'browser', 'vscode', 'photos', 'paint', 'calculator', 'video', 'snake', 'settings']
                    .filter(id => Apps[id])
                    .slice(0, 10);

                const desktopDir = FileSystem.resolve('/Desktop');
                const desktopEntries = Object.entries(desktopDir.children);
                desktopEntries.sort(([aName, aNode], [bName, bNode]) => {
                    if (aNode.type !== bNode.type) return aNode.type === 'dir' ? -1 : 1;
                    return aName.localeCompare(bName, undefined, { numeric: true, sensitivity: 'base' });
                });

                const iconSize = { w: 96, h: 96 };
                const iconGap = { x: 16, y: 10 };
                const usableHeight = Math.max(1, container.clientHeight - 8);
                const strideY = iconSize.h + iconGap.y;
                const strideX = iconSize.w + iconGap.x;
                const maxRows = Math.max(1, Math.floor(usableHeight / strideY));
                let idx = 0;

                const placeIcon = (el, index) => {
                    const row = index % maxRows;
                    const col = Math.floor(index / maxRows);
                    el.style.position = 'absolute';
                    el.style.width = iconSize.w + 'px';
                    el.style.left = (col * strideX) + 'px';
                    el.style.top = (row * strideY) + 'px';
                };

                shortcuts.forEach(appId => {
                    const app = Apps[appId];
                    const el = document.createElement('div');
                    el.className = 'flex flex-col items-center gap-1 p-2 hover:bg-white/20 rounded cursor-pointer text-center desktop-icon group';
                    el.innerHTML = `
                        <i class="${app.icon} ${app.color} text-3xl drop-shadow-md group-hover:scale-110 transition-transform"></i>
                        <span class="text-xs text-white break-words line-clamp-2 leading-tight bg-black/20 px-1 rounded">${app.name}</span>
                    `;
                    el.ondblclick = () => WindowManager.open(appId);
                    placeIcon(el, idx++);
                    container.appendChild(el);
                });

                desktopEntries.forEach(([name, node]) => {
                    const el = document.createElement('div');
                    el.className = 'flex flex-col items-center gap-1 p-2 hover:bg-white/20 rounded cursor-pointer text-center desktop-icon group';
                    
                    let iconClass = 'fa-solid fa-file text-white';
                    if (node.type === 'dir') iconClass = 'fa-solid fa-folder text-yellow-400';
                    else if (name.endsWith('.py')) iconClass = 'fa-brands fa-python text-yellow-300';
                    else if (name.endsWith('.html')) iconClass = 'fa-brands fa-html5 text-orange-500';
                    else if (name.endsWith('.txt')) iconClass = 'fa-solid fa-file-lines text-gray-300';
                    else if (name.match(/\.(jpg|jpeg|png|gif)$/i)) iconClass = 'fa-regular fa-image text-purple-400';

                    el.innerHTML = `
                        <i class="${iconClass} text-3xl drop-shadow-md group-hover:scale-110 transition-transform"></i>
                        <span class="text-xs text-white break-words line-clamp-2 leading-tight bg-black/20 px-1 rounded">${name}</span>
                    `;
                    el.ondblclick = () => {
                        if (node.type === 'dir') WindowManager.open('explorer', '/Desktop/' + name);
                        else {
                            if (name.endsWith('.py')) WindowManager.open('vscode', '/Desktop/' + name);
                            else if (name.match(/\.(jpg|jpeg|png|gif)$/i)) WindowManager.open('photos', '/Desktop/' + name);
                            else WindowManager.open('notepad', '/Desktop/' + name);
                        }
                    };
                    el.oncontextmenu = (e) => {
                        e.preventDefault();
                        // Context menu logic
                    };
                    placeIcon(el, idx++);
                    container.appendChild(el);
                });
            }
        }

        const WindowManager = new WM();

        // --- Apps Implementations ---

        class ExplorerApp {
            constructor(container, initialPath) {
                this.path = initialPath ?? '/Desktop';
                this.container = container;
                this.selectedName = null;
                this.render();
            }

            render() {
                const dir = FileSystem.resolve(this.path);
                if (!dir) return;
                if (this.selectedName && !dir.children[this.selectedName]) this.selectedName = null;
                
                this.container.innerHTML = `
                    <div class="h-full flex flex-col">
                        <div class="bg-gray-50 border-b p-2 flex gap-2 items-center text-sm">
                            <button class="hover:bg-gray-200 p-1 rounded" onclick="this.closest('.window-content').app.goUp()"><i class="fa-solid fa-arrow-up"></i></button>
                            <input type="text" value="${this.path}" class="flex-1 border rounded px-2 py-1 bg-white text-gray-700" readonly>
                            <button class="hover:bg-gray-200 p-1 rounded" onclick="this.closest('.window-content').app.refresh()"><i class="fa-solid fa-rotate-right"></i></button>
                            <div class="w-px h-5 bg-gray-200 mx-1"></div>
                            <button class="hover:bg-gray-200 px-2 py-1 rounded" onclick="this.closest('.window-content').app.createNewFile()"><i class="fa-regular fa-file mr-1"></i>New</button>
                            <button class="hover:bg-gray-200 px-2 py-1 rounded" onclick="this.closest('.window-content').app.createNewFolder()"><i class="fa-regular fa-folder mr-1"></i>Folder</button>
                            <button class="hover:bg-gray-200 px-2 py-1 rounded ${this.selectedName ? '' : 'opacity-40 pointer-events-none'}" onclick="this.closest('.window-content').app.renameSelected()"><i class="fa-solid fa-i-cursor mr-1"></i>Rename</button>
                            <button class="hover:bg-gray-200 px-2 py-1 rounded ${this.selectedName ? '' : 'opacity-40 pointer-events-none'}" onclick="this.closest('.window-content').app.deleteSelected()"><i class="fa-regular fa-trash-can mr-1"></i>Delete</button>
                        </div>
                        <div class="flex-1 overflow-auto p-4 grid grid-cols-[repeat(auto-fill,minmax(80px,1fr))] gap-4 content-start">
                            ${Object.entries(dir.children).map(([name, node]) => {
                                let iconClass = 'fa-regular fa-file text-gray-500';
                                if (node.type === 'dir') iconClass = 'fa-solid fa-folder text-yellow-500';
                                else if (name.endsWith('.py')) iconClass = 'fa-brands fa-python text-yellow-500';
                                else if (name.endsWith('.html')) iconClass = 'fa-brands fa-html5 text-orange-500';
                                else if (name.match(/\.(jpg|jpeg|png|gif)$/i)) iconClass = 'fa-regular fa-image text-purple-500';
                                const selectedClass = this.selectedName === name ? 'bg-blue-100 ring-2 ring-blue-300' : '';
                                
                                return `
                                <div class="flex flex-col items-center gap-2 group cursor-pointer p-2 hover:bg-blue-50 rounded ${selectedClass}" 
                                     data-name="${name}"
                                     onclick="this.closest('.window-content').app.selectItem('${name}', this)"
                                     ondblclick="this.closest('.window-content').app.openItem('${name}', '${node.type}')">
                                    <i class="${iconClass} text-4xl group-hover:scale-110 transition-transform"></i>
                                    <span class="text-xs text-center text-gray-700 group-hover:text-blue-700 break-all">${name}</span>
                                </div>
                            `}).join('')}
                        </div
                        <div class="bg-gray-50 border-t p-1 px-2 text-xs text-gray-500 flex justify-between">
                            <span>${Object.keys(dir.children).length} items</span>
                            <span>${this.selectedName ? 'Selected: ' + this.selectedName : ''}</span>
                        </div>
                    </div>
                `;
                this.container.app = this;
            }

            selectItem(name, el) {
                this.selectedName = name;
                this.updateSelectionVisuals(el);
                const footerSel = this.container.querySelector('.bg-gray-50.border-t span:last-child');
                if (footerSel) footerSel.textContent = this.selectedName ? 'Selected: ' + this.selectedName : '';
            }

            openItem(name, type) {
                const fullPath = this.path === '/' ? '/' + name : this.path + '/' + name;
                if (type === 'dir') {
                    this.path = fullPath;
                    this.selectedName = null;
                    this.render();
                } else {
                    // File association
                    if (name.endsWith('.py')) WindowManager.open('vscode', fullPath);
                    else if (name.endsWith('.html')) WindowManager.open('vscode', fullPath);
                    else if (name.match(/\.(jpg|jpeg|png|gif|webp)$/i)) WindowManager.open('photos', fullPath);
                    else WindowManager.open('notepad', fullPath);
                }
            }
            
            updateSelectionVisuals(activeEl) {
                const cards = this.container.querySelectorAll('[data-name]');
                cards.forEach(card => {
                    card.classList.remove('bg-blue-100', 'ring-2', 'ring-blue-300');
                });
                if (activeEl) {
                    activeEl.classList.add('bg-blue-100', 'ring-2', 'ring-blue-300');
                } else if (this.selectedName) {
                    const el = this.container.querySelector(`[data-name="${CSS.escape(this.selectedName)}"]`);
                    if (el) el.classList.add('bg-blue-100', 'ring-2', 'ring-blue-300');
                }
            }

            async createNewFile() {
                const suggested = this.path === '/Desktop' ? 'New Text Document.txt' : 'new.txt';
                const name = await Dialog.prompt('New file name:', { title: 'New File', defaultValue: suggested, okText: 'Create', cancelText: 'Cancel' });
                if (!name) return;
                if (!FileSystem.createFile(this.path, name, '')) {
                    await Dialog.alert('A file or folder with the same name already exists.', { title: 'Cannot Create' });
                    return;
                }
                this.selectedName = name;
                this.render();
                WindowManager.refreshDesktop();
            }

            async createNewFolder() {
                const name = await Dialog.prompt('New folder name:', { title: 'New Folder', defaultValue: 'New Folder', okText: 'Create', cancelText: 'Cancel' });
                if (!name) return;
                if (!FileSystem.createFolder(this.path, name)) {
                    await Dialog.alert('A file or folder with the same name already exists.', { title: 'Cannot Create' });
                    return;
                }
                this.selectedName = name;
                this.render();
                WindowManager.refreshDesktop();
            }

            async renameSelected() {
                if (!this.selectedName) return;
                const next = await Dialog.prompt('Rename to:', { title: 'Rename', defaultValue: this.selectedName, okText: 'Rename', cancelText: 'Cancel' });
                if (!next) return;
                const targetPath = this.path === '/' ? '/' + this.selectedName : this.path + '/' + this.selectedName;
                if (!FileSystem.rename(targetPath, next)) {
                    await Dialog.alert('Rename failed (duplicate name or invalid).', { title: 'Rename Failed' });
                    return;
                }
                this.selectedName = next;
                this.render();
                WindowManager.refreshDesktop();
            }

            async deleteSelected() {
                if (!this.selectedName) return;
                const targetPath = this.path === '/' ? '/' + this.selectedName : this.path + '/' + this.selectedName;
                const ok = await Dialog.confirm(`Delete "${this.selectedName}"?`, { title: 'Confirm Delete', okText: 'Delete', cancelText: 'Cancel' });
                if (!ok) return;
                FileSystem.delete(targetPath);
                this.selectedName = null;
                this.render();
                WindowManager.refreshDesktop();
            }

            goUp() {
                if (this.path === '/' || this.path === '') return;
                const parts = this.path.split('/').filter(p => p);
                parts.pop();
                this.path = parts.length === 0 ? '/' : '/' + parts.join('/');
                this.selectedName = null;
                this.render();
            }

            refresh() { this.render(); }
        }

        class NotepadApp {
            constructor(container, filePath) {
                this.path = filePath;
                this.content = filePath ? (FileSystem.resolve(filePath)?.content || '') : '';
                this.container = container;
                this.render();
            }

            render() {
                this.container.innerHTML = `
                    <div class="h-full flex flex-col">
                        <div class="flex gap-2 p-1 border-b bg-gray-50 text-sm">
                            <button class="px-2 hover:bg-gray-200 rounded" onclick="this.closest('.window-content').app.save()">Save</button>
                            <button class="px-2 hover:bg-gray-200 rounded" onclick="this.closest('.window-content').app.saveAs()">Save As</button>
                        </div>
                        <textarea class="flex-1 resize-none p-2 focus:outline-none font-mono text-sm bg-white text-gray-900 select-text" spellcheck="false">${this.content}</textarea>
                    </div>
                `;
                this.container.app = this;
            }

            async save() {
                const val = this.container.querySelector('textarea').value;
                if (this.path) {
                    FileSystem.writeFile(this.path, val);
                    await Dialog.alert('Saved.', { title: 'Notepad' });
                } else {
                    await this.saveAs();
                }
            }

            async saveAs() {
                const name = await Dialog.prompt('Enter filename (e.g., /Desktop/new.txt):', {
                    title: 'Save As',
                    defaultValue: this.path || '/Desktop/untitled.txt',
                    okText: 'Save',
                    cancelText: 'Cancel'
                });
                if (name) {
                    const val = this.container.querySelector('textarea').value;
                    if(FileSystem.writeFile(name, val)) {
                        this.path = name;
                        await Dialog.alert('Saved to ' + name, { title: 'Save As' });
                        WindowManager.refreshDesktop();
                    } else {
                        await Dialog.alert('Invalid path or parent directory does not exist.', { title: 'Save Failed' });
                    }
                }
            }
        }

        class TerminalApp {
            constructor(container) {
                this.container = container;
                this.history = [];
                this.historyIndex = 0;
                this.cwd = '/';
                this.pythonMode = false;
                this.pythonBuffer = [];
                this.render();
                this.initPyodide();
            }

            async initPyodide() {
                this.log("Initializing Python Kernel...", "text-yellow-500");
                if (!window.pyodide) {
                    try {
                        window.pyodide = await initPyodideRuntime();
                        // Mock FS mount
                        this.log("Python Ready. Type 'python' to enter REPL or 'python <file>' to run.", "text-green-500");
                    } catch (e) {
                        this.log("Failed to load Python: " + e.message, "text-red-500");
                    }
                } else {
                    this.log("Python Ready.", "text-green-500");
                }
            }

            render() {
                this.container.classList.add('bg-black', 'text-gray-200', 'font-mono', 'text-sm', 'p-2', 'h-full', 'overflow-hidden', 'flex', 'flex-col', 'crt');
                this.container.innerHTML = `
                    <div id="term-output" class="flex-1 overflow-y-auto mb-2 whitespace-pre-wrap">WebOS Terminal v1.0\nType 'help' for commands.\n</div>
                    <div class="flex">
                        <span class="text-green-400 mr-2 prompt-text">root@webos:/$</span>
                        <input type="text" class="bg-transparent border-none focus:outline-none flex-1 text-white" autofocus>
                    </div>
                `;
                
                const input = this.container.querySelector('input');
                input.addEventListener('keydown', async (e) => {
                    if (!this.pythonMode && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
                        e.preventDefault();
                        if (this.history.length === 0) return;
                        if (e.key === 'ArrowUp') this.historyIndex = Math.max(0, this.historyIndex - 1);
                        if (e.key === 'ArrowDown') this.historyIndex = Math.min(this.history.length, this.historyIndex + 1);
                        input.value = this.historyIndex >= this.history.length ? '' : this.history[this.historyIndex];
                        return;
                    }
                    if (e.key === 'Enter') {
                        const cmd = input.value;
                        if (this.pythonMode) {
                            this.log(`>>> ${cmd}`);
                        } else {
                            if (cmd.trim()) {
                                this.history.push(cmd);
                                this.historyIndex = this.history.length;
                            }
                            this.log(`root@webos:${this.cwd}$ ${cmd}`);
                        }
                        input.value = '';
                        await this.execute(cmd);
                        // Scroll to bottom
                        const out = this.container.querySelector('#term-output');
                        out.scrollTop = out.scrollHeight;
                    }
                });
                
                this.container.addEventListener('click', () => input.focus());
            }

            log(text, color = "text-gray-300") {
                const out = this.container.querySelector('#term-output');
                const div = document.createElement('div');
                div.className = color;
                div.textContent = text;
                out.appendChild(div);
            }

            setPrompt(text) {
                const prompt = this.container.querySelector('.prompt-text');
                if (prompt) prompt.textContent = text;
            }

            enterPythonRepl() {
                if (!window.pyodide) {
                    this.log("Python not ready.", "text-red-500");
                    return;
                }
                this.pythonMode = true;
                this.pythonBuffer = [];
                this.log("Python (Pyodide) REPL. Type exit() or quit to return.", "text-green-500");
                this.setPrompt(">>>");
            }

            exitPythonRepl() {
                this.pythonMode = false;
                this.pythonBuffer = [];
                this.setPrompt(`root@webos:${this.cwd}$`);
            }

            async executePythonLine(line) {
                if (!window.pyodide) {
                    this.log("Python not ready.", "text-red-500");
                    return;
                }
                const trimmed = line.trim();
                if (trimmed === 'exit()' || trimmed === 'quit()' || trimmed === 'quit' || trimmed === 'exit') {
                    this.exitPythonRepl();
                    return;
                }

                if (trimmed === '' && this.pythonBuffer.length === 0) return;

                const needsBlock = trimmed.endsWith(':') || (this.pythonBuffer.length > 0 && (line.startsWith(' ') || line.startsWith('\t')));
                if (needsBlock) {
                    this.pythonBuffer.push(line);
                    this.setPrompt("...");
                    return;
                }

                const code = this.pythonBuffer.length > 0 ? (this.pythonBuffer.join('\n') + '\n' + line) : line;
                this.pythonBuffer = [];
                this.setPrompt(">>>");
                try {
                    window.pyodide.setStdout({ batched: (msg) => this.log(msg) });
                    const result = await window.pyodide.runPythonAsync(code);
                    if (result !== undefined && String(result) !== 'None') this.log(String(result));
                } catch (e) {
                    this.log(String(e), "text-red-400");
                }
            }

            async execute(cmdStr) {
                if (this.pythonMode) {
                    await this.executePythonLine(cmdStr);
                    return;
                }
                const args = cmdStr.trim().split(' ');
                const cmd = args[0];

                switch(cmd) {
                    case 'help':
                        this.log("Available commands: ls, cd, cat, pwd, clear, mkdir, rm, python");
                        break;
                    case 'clear':
                        this.container.querySelector('#term-output').innerHTML = '';
                        break;
                    case 'ls':
                        const dir = FileSystem.resolve(this.cwd);
                        if(dir && dir.type === 'dir') {
                            this.log(Object.keys(dir.children).join('  '), "text-blue-400");
                        } else {
                            this.log("Error: Current directory invalid", "text-red-500");
                        }
                        break;
                    case 'pwd':
                        this.log(this.cwd);
                        break;
                    case 'cd':
                        const target = args[1] || '/';
                        let newPath = target.startsWith('/') ? target : (this.cwd === '/' ? '/' + target : this.cwd + '/' + target);
                        // Simple path normalization
                        if (target === '..') {
                            const parts = this.cwd.split('/').filter(p => p);
                            parts.pop();
                            newPath = parts.length === 0 ? '/' : '/' + parts.join('/');
                        }
                        
                        if (FileSystem.resolve(newPath)?.type === 'dir') {
                            this.cwd = newPath;
                            this.setPrompt(`root@webos:${this.cwd}$`);
                        } else {
                            this.log(`cd: ${target}: No such directory`, "text-red-500");
                        }
                        break;
                    case 'cat':
                        if (!args[1]) { this.log("Usage: cat <filename>"); break; }
                        const filePath = args[1].startsWith('/') ? args[1] : (this.cwd === '/' ? '/' + args[1] : this.cwd + '/' + args[1]);
                        const node = FileSystem.resolve(filePath);
                        if (node && node.type === 'file') {
                            this.log(node.content);
                        } else {
                            this.log(`cat: ${args[1]}: No such file`, "text-red-500");
                        }
                        break;
                    case 'rm':
                        if (!args[1]) { this.log("Usage: rm <path>", "text-yellow-400"); break; }
                        const rmPath = args[1].startsWith('/') ? args[1] : (this.cwd === '/' ? '/' + args[1] : this.cwd + '/' + args[1]);
                        if (FileSystem.delete(rmPath)) {
                            this.log(`Removed ${rmPath}`, "text-green-500");
                        } else {
                            this.log(`rm: ${args[1]}: No such file or directory`, "text-red-500");
                        }
                        break;
                    case 'python':
                        if (!window.pyodide) { this.log("Python not ready.", "text-red-500"); return; }
                        if (args.length === 1) {
                            this.enterPythonRepl();
                            break;
                        }
                        const scriptArg = args[1];
                        const pyPath = scriptArg.startsWith('/') ? scriptArg : (this.cwd === '/' ? '/' + scriptArg : this.cwd + '/' + scriptArg);
                        const pyNode = FileSystem.resolve(pyPath);
                        if (pyNode && pyNode.type === 'file') {
                            try {
                                window.pyodide.setStdout({ batched: (msg) => this.log(msg) });
                                await window.pyodide.runPythonAsync(pyNode.content);
                            } catch(e) {
                                this.log(e.toString(), "text-red-400");
                            }
                        } else {
                            this.log(`python: ${scriptArg}: File not found`, "text-red-500");
                        }
                        break;
                    case 'mkdir':
                         if (!args[1]) break;
                         const mkPath = args[1].startsWith('/') ? args[1] : (this.cwd === '/' ? '/' + args[1] : this.cwd + '/' + args[1]);
                         FileSystem.mkdir(mkPath);
                         this.log(`Created directory ${mkPath}`);
                         break;
                    default:
                        if(cmd) this.log(`Command not found: ${cmd}`, "text-red-500");
                }
            }
        }

        class PaintApp {
            constructor(container) {
                this.container = container;
                this.color = '#000000';
                this.size = 2;
                this._resizeObserver = null;
                this._canvas = null;
                this._ctx = null;
                this.render();
            }

            render() {
                this.container.innerHTML = `
                    <div class="flex flex-col h-full">
                        <div class="bg-gray-100 p-2 border-b flex gap-4 items-center">
                            <input type="color" value="${this.color}" onchange="this.parentElement.app.color = this.value">
                            <input type="range" min="1" max="20" value="2" onchange="this.parentElement.app.size = this.value">
                            <button class="bg-white border px-2 rounded hover:bg-gray-50" onclick="this.parentElement.app.clear()">Clear</button>
                        </div>
                        <div class="flex-1 bg-white relative overflow-hidden cursor-crosshair">
                            <canvas></canvas>
                        </div>
                    </div>
                `;
                
                const tools = this.container.querySelector('.bg-gray-100');
                tools.app = this;
                
                this.initCanvas();
            }

            initCanvas() {
                const canvas = this.container.querySelector('canvas');
                const wrapper = canvas.parentElement;
                
                this._canvas = canvas;
                this._ctx = canvas.getContext('2d');
                this.resizeCanvasToWrapper();

                let painting = false;

                const startPos = (e) => {
                    painting = true;
                    draw(e);
                };
                const endPos = () => {
                    painting = false;
                    this._ctx.beginPath();
                };
                const draw = (e) => {
                    if (!painting) return;
                    const rect = canvas.getBoundingClientRect();
                    this._ctx.lineWidth = Number(this.size);
                    this._ctx.lineCap = 'round';
                    this._ctx.strokeStyle = this.color;
                    
                    this._ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                    this._ctx.stroke();
                    this._ctx.beginPath();
                    this._ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
                };

                canvas.addEventListener('mousedown', startPos);
                canvas.addEventListener('mouseup', endPos);
                canvas.addEventListener('mousemove', draw);

                if (this._resizeObserver) this._resizeObserver.disconnect();
                this._resizeObserver = new ResizeObserver(() => this.resizeCanvasToWrapper());
                this._resizeObserver.observe(wrapper);
            }

            resizeCanvasToWrapper() {
                const canvas = this._canvas || this.container.querySelector('canvas');
                if (!canvas) return;
                const wrapper = canvas.parentElement;
                if (!wrapper) return;
                const nextW = Math.max(1, Math.floor(wrapper.clientWidth));
                const nextH = Math.max(1, Math.floor(wrapper.clientHeight));
                if (canvas.width === nextW && canvas.height === nextH) return;

                const prev = document.createElement('canvas');
                prev.width = canvas.width || 1;
                prev.height = canvas.height || 1;
                const prevCtx = prev.getContext('2d');
                prevCtx.drawImage(canvas, 0, 0);

                canvas.width = nextW;
                canvas.height = nextH;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(prev, 0, 0);
                this._ctx = ctx;
            }

            clear() {
                const canvas = this._canvas || this.container.querySelector('canvas');
                if (!canvas) return;
                const ctx = this._ctx || canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        class SnakeApp {
            constructor(container) {
                this.container = container;
                this.winId = this.container.dataset.winId || null;
                this.box = 20;
                this.size = 400;
                this.intervalMs = 110;
                this.direction = 'RIGHT';
                this.nextDirection = 'RIGHT';
                this.paused = false;
                this.score = 0;
                this.snake = [{ x: 9 * this.box, y: 10 * this.box }];
                this.food = this.randomFood();
                this.timer = null;
                this.keyHandler = (event) => this.onKeyDown(event);
                this.render();
                this.start();
            }
            
            render() {
                this.container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full bg-gray-800 text-white gap-2">
                        <div class="flex items-center gap-3">
                            <div class="text-sm">Score: <span id="score">0</span></div>
                            <button class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs px-3 py-1.5 rounded" onclick="this.closest('.window-content').app.togglePause()">
                                <span id="pause-label">Pause</span>
                            </button>
                            <button class="bg-gray-700 hover:bg-gray-600 active:bg-gray-800 text-white text-xs px-3 py-1.5 rounded" onclick="this.closest('.window-content').app.reset()">
                                Restart
                            </button>
                        </div>
                        <canvas width="400" height="400" class="bg-black border border-gray-600 rounded" tabindex="0"></canvas>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div></div>
                            <button class="bg-white/10 hover:bg-white/20 active:bg-white/30 px-3 py-2 rounded" onclick="this.closest('.window-content').app.setDirection('UP')"></button>
                            <div></div>
                            <button class="bg-white/10 hover:bg-white/20 active:bg-white/30 px-3 py-2 rounded" onclick="this.closest('.window-content').app.setDirection('LEFT')"></button>
                            <button class="bg-white/10 hover:bg-white/20 active:bg-white/30 px-3 py-2 rounded" onclick="this.closest('.window-content').app.setDirection('DOWN')"></button>
                            <button class="bg-white/10 hover:bg-white/20 active:bg-white/30 px-3 py-2 rounded" onclick="this.closest('.window-content').app.setDirection('RIGHT')"></button>
                        </div>
                        <div class="text-xs text-gray-300">Click the game window then use Arrow Keys</div>
                    </div>
                `;
                this.container.app = this;
                const canvas = this.container.querySelector('canvas');
                canvas.addEventListener('mousedown', () => canvas.focus());
                this.updateHud();
                this.draw();
            }

            isActive() {
                if (!this.winId) return true;
                return WindowManager.activeWindowId === this.winId;
            }

            randomFood() {
                const max = (this.size / this.box) - 1;
                const randCell = () => Math.floor(Math.random() * (max + 1)) * this.box;
                let x = randCell();
                let y = randCell();
                const occupied = (cx, cy) => this.snake.some(s => s.x === cx && s.y === cy);
                let guard = 0;
                while (occupied(x, y) && guard++ < 200) {
                    x = randCell();
                    y = randCell();
                }
                return { x, y };
            }

            onKeyDown(event) {
                if (!this.isActive()) return;
                if (event.key && event.key.startsWith('Arrow')) event.preventDefault();
                const key = event.key;
                if (key === 'ArrowLeft') this.setDirection('LEFT');
                if (key === 'ArrowUp') this.setDirection('UP');
                if (key === 'ArrowRight') this.setDirection('RIGHT');
                if (key === 'ArrowDown') this.setDirection('DOWN');
                if (key === ' ' || key === 'Enter') this.togglePause();
            }

            setDirection(dir) {
                const opposite = (a, b) =>
                    (a === 'LEFT' && b === 'RIGHT') ||
                    (a === 'RIGHT' && b === 'LEFT') ||
                    (a === 'UP' && b === 'DOWN') ||
                    (a === 'DOWN' && b === 'UP');
                if (!opposite(dir, this.direction)) this.nextDirection = dir;
            }

            togglePause() {
                this.paused = !this.paused;
                this.updateHud();
            }

            updateHud() {
                const scoreEl = this.container.querySelector('#score');
                if (scoreEl) scoreEl.textContent = String(this.score);
                const label = this.container.querySelector('#pause-label');
                if (label) label.textContent = this.paused ? 'Resume' : 'Pause';
            }

            reset() {
                this.direction = 'RIGHT';
                this.nextDirection = 'RIGHT';
                this.paused = false;
                this.score = 0;
                this.snake = [{ x: 9 * this.box, y: 10 * this.box }];
                this.food = this.randomFood();
                this.updateHud();
                this.draw();
            }

            start() {
                window.addEventListener('keydown', this.keyHandler, { passive: false });
                if (this.timer) clearInterval(this.timer);
                this.timer = setInterval(() => this.tick(), this.intervalMs);
            }

            stop() {
                if (this.timer) clearInterval(this.timer);
                this.timer = null;
                window.removeEventListener('keydown', this.keyHandler);
            }

            tick() {
                const canvas = this.container.querySelector('canvas');
                if (!canvas || !document.contains(canvas)) {
                    this.stop();
                    return;
                }
                if (!this.isActive()) return;
                if (this.paused) return;

                this.direction = this.nextDirection;
                const head = this.snake[0];
                let x = head.x;
                let y = head.y;
                if (this.direction === 'LEFT') x -= this.box;
                if (this.direction === 'RIGHT') x += this.box;
                if (this.direction === 'UP') y -= this.box;
                if (this.direction === 'DOWN') y += this.box;

                const out = x < 0 || x > (this.size - this.box) || y < 0 || y > (this.size - this.box);
                const hit = this.snake.some((s, i) => i > 0 && s.x === x && s.y === y);
                if (out || hit) {
                    this.paused = true;
                    this.updateHud();
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'rgba(0,0,0,0.65)';
                    ctx.fillRect(0, 0, this.size, this.size);
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 20px Segoe UI, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(`Game Over  Score ${this.score}`, this.size / 2, this.size / 2);
                    ctx.font = '12px Segoe UI, sans-serif';
                    ctx.fillText('Press Restart', this.size / 2, this.size / 2 + 24);
                    return;
                }

                const newHead = { x, y };
                this.snake.unshift(newHead);

                if (x === this.food.x && y === this.food.y) {
                    this.score += 1;
                    this.food = this.randomFood();
                } else {
                    this.snake.pop();
                }

                this.updateHud();
                this.draw();
            }

            draw() {
                const canvas = this.container.querySelector('canvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, this.size, this.size);

                ctx.fillStyle = 'orange';
                ctx.fillRect(this.food.x, this.food.y, this.box, this.box);

                for (let i = 0; i < this.snake.length; i++) {
                    ctx.fillStyle = i === 0 ? '#22c55e' : '#e5e7eb';
                    ctx.fillRect(this.snake[i].x, this.snake[i].y, this.box, this.box);
                    ctx.strokeStyle = '#ef4444';
                    ctx.strokeRect(this.snake[i].x, this.snake[i].y, this.box, this.box);
                }
            }
        }
        
        class BrowserApp {
            constructor(container) {
                this.container = container;
                this.history = [];
                this.historyIndex = -1;
                this.render();
                this.navigate('https://www.wikipedia.org/');
            }
            render() {
                this.container.innerHTML = `
                    <div class="flex flex-col h-full">
                        <div class="flex gap-2 p-2 bg-gray-100 border-b items-center">
                            <button class="px-2 py-1 rounded border bg-white text-gray-800 hover:bg-gray-50 disabled:opacity-40" onclick="this.closest('.window-content').app.back()" id="nav-back"></button>
                            <button class="px-2 py-1 rounded border bg-white text-gray-800 hover:bg-gray-50 disabled:opacity-40" onclick="this.closest('.window-content').app.forward()" id="nav-forward"></button>
                            <input type="text" value="https://www.wikipedia.org/" class="flex-1 px-3 py-1 rounded border text-sm bg-white text-gray-800 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-400" id="url-input">
                            <button class="bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600" onclick="this.closest('.window-content').app.go()">Go</button>
                        </div>
                        <div class="flex-1 relative">
                            <div class="absolute inset-0 hidden items-center justify-center bg-white/70 text-gray-700 text-sm" id="browser-loading">Loading...</div>
                            <iframe src="about:blank" class="absolute inset-0 w-full h-full border-none bg-white"></iframe>
                        </div>
                    </div>
                `;
                this.container.app = this;
                const input = this.container.querySelector('#url-input');
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') this.go();
                });
            }

            normalizeUrl(raw) {
                const v = String(raw || '').trim();
                if (!v) return null;
                if (v.startsWith('http://') || v.startsWith('https://')) return v;
                return 'https://' + v;
            }

            setLoading(loading) {
                const el = this.container.querySelector('#browser-loading');
                if (!el) return;
                el.classList.toggle('hidden', !loading);
                el.classList.toggle('flex', loading);
            }

            updateNavButtons() {
                const back = this.container.querySelector('#nav-back');
                const forward = this.container.querySelector('#nav-forward');
                if (back) back.disabled = !(this.historyIndex > 0);
                if (forward) forward.disabled = !(this.historyIndex >= 0 && this.historyIndex < this.history.length - 1);
            }

            async load(url) {
                const iframe = this.container.querySelector('iframe');
                const input = this.container.querySelector('#url-input');
                if (!iframe || !input) return;
                input.value = url;
                this.setLoading(true);
                try {
                    const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
                    const res = await fetch(proxy, { method: 'GET' });
                    const html = await res.text();
                    const withBase = `<base href="${url}">` + html;
                    iframe.srcdoc = withBase;
                } catch (e) {
                    iframe.srcdoc = '';
                    iframe.src = url;
                } finally {
                    this.setLoading(false);
                    this.updateNavButtons();
                }
            }

            navigate(rawUrl) {
                const url = this.normalizeUrl(rawUrl);
                if (!url) return;
                if (this.historyIndex < this.history.length - 1) {
                    this.history = this.history.slice(0, this.historyIndex + 1);
                }
                this.history.push(url);
                this.historyIndex = this.history.length - 1;
                this.load(url);
            }

            go() {
                const input = this.container.querySelector('#url-input');
                const url = this.normalizeUrl(input?.value);
                if (!url) return;
                this.navigate(url);
            }

            back() {
                if (this.historyIndex <= 0) return;
                this.historyIndex -= 1;
                this.load(this.history[this.historyIndex]);
            }

            forward() {
                if (this.historyIndex >= this.history.length - 1) return;
                this.historyIndex += 1;
                this.load(this.history[this.historyIndex]);
            }
        }

        class VideoApp {
            constructor(container) {
                this.container = container;
                this.start = 0;
                this.end = null;
                this.loop = false;
                this.render();
            }
            render() {
                this.container.innerHTML = `
                    <div class="flex flex-col h-full bg-black min-h-0">
                        <div class="flex-1 min-h-0 flex items-center justify-center p-3">
                            <video controls class="max-h-full max-w-full rounded-lg shadow-2xl" id="video-el">
                                <source src="https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                        <div class="bg-gray-900 border-t border-white/10 p-3 text-white">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm font-semibold">Simple Video Editor</div>
                                <div class="text-xs text-gray-300"><span id="video-time">0.0</span>s</div>
                            </div>
                            <div class="grid grid-cols-1 gap-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-14 text-xs text-gray-300">Start</div>
                                    <input type="range" min="0" max="0" step="0.1" value="0" class="flex-1 accent-blue-500" id="start-range">
                                    <div class="w-14 text-right text-xs text-gray-300"><span id="start-val">0.0</span>s</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="w-14 text-xs text-gray-300">End</div>
                                    <input type="range" min="0" max="0" step="0.1" value="0" class="flex-1 accent-blue-500" id="end-range">
                                    <div class="w-14 text-right text-xs text-gray-300"><span id="end-val">0.0</span>s</div>
                                </div>
                                <div class="flex items-center gap-2 mt-1">
                                    <button class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-xs px-3 py-1.5 rounded" onclick="this.closest('.window-content').app.playSegment()">Play Segment</button>
                                    <button class="bg-gray-700 hover:bg-gray-600 active:bg-gray-800 text-white text-xs px-3 py-1.5 rounded" onclick="this.closest('.window-content').app.setStartToCurrent()">Set Start</button>
                                    <button class="bg-gray-700 hover:bg-gray-600 active:bg-gray-800 text-white text-xs px-3 py-1.5 rounded" onclick="this.closest('.window-content').app.setEndToCurrent()">Set End</button>
                                    <button class="bg-purple-600 hover:bg-purple-700 active:bg-purple-800 text-white text-xs px-3 py-1.5 rounded" onclick="this.closest('.window-content').app.toggleLoop()"><span id="loop-label">Loop: Off</span></button>
                                    <button class="bg-red-600 hover:bg-red-700 active:bg-red-800 text-white text-xs px-3 py-1.5 rounded" onclick="this.closest('.window-content').app.resetTrim()">Reset</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                this.container.app = this;
                this.initVideoEditor();
            }

            initVideoEditor() {
                const video = this.container.querySelector('#video-el');
                const startRange = this.container.querySelector('#start-range');
                const endRange = this.container.querySelector('#end-range');
                const startVal = this.container.querySelector('#start-val');
                const endVal = this.container.querySelector('#end-val');
                const timeVal = this.container.querySelector('#video-time');
                const loopLabel = this.container.querySelector('#loop-label');

                const syncLabels = () => {
                    startVal.textContent = Number(this.start).toFixed(1);
                    endVal.textContent = Number(this.end ?? 0).toFixed(1);
                    loopLabel.textContent = `Loop: ${this.loop ? 'On' : 'Off'}`;
                };

                const clampRanges = () => {
                    if (this.end === null) this.end = video.duration || 0;
                    this.start = Math.max(0, Math.min(this.start, this.end));
                    this.end = Math.max(this.start, Math.min(this.end, video.duration || this.end));
                    startRange.value = String(this.start);
                    endRange.value = String(this.end);
                    syncLabels();
                };

                video.addEventListener('loadedmetadata', () => {
                    const duration = video.duration || 0;
                    startRange.max = String(duration);
                    endRange.max = String(duration);
                    if (this.end === null) this.end = duration;
                    this.start = Math.max(0, Math.min(this.start, duration));
                    this.end = Math.max(this.start, Math.min(this.end, duration));
                    startRange.value = String(this.start);
                    endRange.value = String(this.end);
                    syncLabels();
                });

                startRange.addEventListener('input', () => {
                    this.start = Number(startRange.value);
                    if (this.end !== null && this.start > this.end) this.end = this.start;
                    clampRanges();
                });

                endRange.addEventListener('input', () => {
                    this.end = Number(endRange.value);
                    if (this.end < this.start) this.start = this.end;
                    clampRanges();
                });

                video.addEventListener('timeupdate', () => {
                    timeVal.textContent = Number(video.currentTime).toFixed(1);
                    if (this.end !== null && video.currentTime >= this.end) {
                        if (this.loop) {
                            video.currentTime = this.start;
                            video.play();
                        } else {
                            video.pause();
                        }
                    }
                });

                syncLabels();
            }

            playSegment() {
                const video = this.container.querySelector('#video-el');
                if (!video) return;
                if (this.end === null) this.end = video.duration || 0;
                video.currentTime = this.start;
                video.play();
            }

            setStartToCurrent() {
                const video = this.container.querySelector('#video-el');
                if (!video) return;
                this.start = Number(video.currentTime || 0);
                if (this.end !== null && this.start > this.end) this.end = this.start;
                this.render();
            }

            setEndToCurrent() {
                const video = this.container.querySelector('#video-el');
                if (!video) return;
                this.end = Number(video.currentTime || 0);
                if (this.end < this.start) this.start = this.end;
                this.render();
            }

            toggleLoop() {
                this.loop = !this.loop;
                const loopLabel = this.container.querySelector('#loop-label');
                if (loopLabel) loopLabel.textContent = `Loop: ${this.loop ? 'On' : 'Off'}`;
            }

            resetTrim() {
                const video = this.container.querySelector('#video-el');
                if (!video) return;
                this.start = 0;
                this.end = video.duration || 0;
                this.loop = false;
                this.render();
            }
        }
        
        class CodeApp {
            constructor(container, path) {
                this.container = container;
                this.path = path || '/Desktop/script.py';
                this.content = this.path ? (FileSystem.resolve(this.path)?.content || '# Python Script\nprint("Hello World")') : '';
                this.render();
            }
            render() {
                this.container.innerHTML = `
                    <div class="flex flex-col h-full bg-[#1e1e1e]">
                        <div class="flex justify-between items-center p-2 bg-[#2d2d2d] border-b border-[#3e3e3e]">
                            <span class="text-gray-300 text-xs">${this.path}</span>
                            <div class="flex gap-2">
                                <button class="text-xs bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded" onclick="this.closest('.window-content').app.run()">Run</button>
                                <button class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded" onclick="this.closest('.window-content').app.save()">Save</button>
                            </div>
                        </div>
                        <textarea class="flex-1 bg-[#1e1e1e] text-[#d4d4d4] p-4 font-mono text-sm resize-none focus:outline-none select-text" spellcheck="false">${this.content}</textarea>
                        <div class="h-24 bg-[#1e1e1e] border-t border-[#3e3e3e] p-2 overflow-auto font-mono text-xs text-gray-400" id="code-output">Output will appear here...</div>
                    </div>
                `;
                this.container.app = this;
            }
            async save() {
                const val = this.container.querySelector('textarea').value;
                FileSystem.writeFile(this.path, val);
                await Dialog.alert('Saved.', { title: 'Code Editor' });
            }
            async run() {
                const code = this.container.querySelector('textarea').value;
                const outDiv = this.container.querySelector('#code-output');
                outDiv.innerHTML = 'Running...<br>';
                
                if(!window.pyodide) {
                    outDiv.innerHTML += '<span class="text-yellow-400">Loading Python runtime...</span><br>';
                    try {
                        window.pyodide = await initPyodideRuntime();
                    } catch (e) {
                        outDiv.innerHTML += `<span class="text-red-500">${e.message || e}</span>`;
                        return;
                    }
                }

                try {
                    window.pyodide.setStdout({ batched: (msg) => outDiv.innerHTML += msg + '<br>' });
                    await window.pyodide.loadPackagesFromImports(code);
                    await window.pyodide.runPythonAsync(code);
                } catch(err) {
                    outDiv.innerHTML += `<span class="text-red-500">${err}</span>`;
                }
            }
        }

        class CalculatorApp {
            constructor(container) {
                this.container = container;
                this.render();
            }
            render() {
                this.container.innerHTML = `
                    <div class="flex flex-col h-full bg-gray-200 p-2 gap-2">
                        <input type="text" class="w-full h-12 text-right text-2xl px-2 border border-gray-300 bg-white text-gray-900" readonly id="calc-display">
                        <div class="grid grid-cols-4 gap-2 flex-1">
                            ${['7','8','9','/','4','5','6','*','1','2','3','-','0','.','=','+','C'].map(btn => 
                                `<button class="bg-white rounded shadow hover:bg-gray-100 font-bold text-gray-900 ${btn === '=' ? 'col-span-2 bg-blue-500 text-white hover:bg-blue-600' : ''} ${btn === 'C' ? 'bg-red-100 hover:bg-red-200' : ''}" onclick="this.closest('.window-content').app.input('${btn}')">${btn}</button>`
                            ).join('')}
                        </div>
                    </div>
                `;
                this.container.app = this;
            }
            input(val) {
                const display = this.container.querySelector('#calc-display');
                if (val === 'C') display.value = '';
                else if (val === '=') {
                    try { display.value = eval(display.value); } catch { display.value = 'Error'; }
                } else {
                    display.value += val;
                }
            }
        }
        
        class PhotoViewerApp {
            constructor(container, path) {
                this.container = container;
                this.path = path;
                this.content = path ? (FileSystem.resolve(path)?.content || '') : '';
                this.render();
            }
            render() {
                if (!this.content) {
                     this.container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No image selected</div>';
                     return;
                }
                this.container.innerHTML = `
                    <div class="flex flex-col h-full bg-black relative group items-center justify-center">
                        <img src="${this.content}" class="max-w-full max-h-full object-contain">
                        <div class="absolute bottom-0 w-full bg-black/50 text-white p-2 text-center opacity-0 group-hover:opacity-100 transition-opacity text-sm">
                            ${this.path}
                        </div>
                    </div>
                `;
            }
        }

        class CalendarApp {
            constructor(container) {
                this.container = container;
                this.selected = new Date();
                this.viewYear = this.selected.getFullYear();
                this.viewMonth = this.selected.getMonth();
                this.render();
            }
            
            render() {
                const clampYear = (y) => Math.max(1900, Math.min(2099, y));
                this.viewYear = clampYear(this.viewYear);
                const year = this.viewYear;
                const month = this.viewMonth;
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                
                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"
                ];
                const weekdayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

                const pad2 = (n) => String(n).padStart(2, '0');
                const toInputDate = (d) => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;

                const selectedWeekday = weekdayNames[this.selected.getDay()];
                const selectedLabel = `${this.selected.getFullYear()}-${pad2(this.selected.getMonth() + 1)}-${pad2(this.selected.getDate())} (${selectedWeekday})`;

                const yearOptions = Array.from({ length: 200 }, (_, i) => 1900 + i)
                    .map(y => `<option value="${y}" ${y === year ? 'selected' : ''}>${y}</option>`)
                    .join('');
                const monthOptions = monthNames
                    .map((m, idx) => `<option value="${idx}" ${idx === month ? 'selected' : ''}>${m}</option>`)
                    .join('');

                let gridHtml = '';
                for(let i=0; i<firstDay; i++) {
                    gridHtml += '<div></div>';
                }
                for(let i=1; i<=daysInMonth; i++) {
                    const isToday = i === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                    const isSelected = i === this.selected.getDate() && month === this.selected.getMonth() && year === this.selected.getFullYear();
                    const base = 'aspect-square flex items-center justify-center rounded-full text-sm cursor-pointer select-none';
                    const cls = isSelected
                        ? 'bg-blue-600 text-white hover:bg-blue-700'
                        : (isToday ? 'bg-blue-100 text-blue-700 hover:bg-blue-200' : 'hover:bg-gray-200');
                    gridHtml += `<div class="${base} ${cls}" onclick="this.closest('.window-content').app.selectDay(${i})">${i}</div>`;
                }

                this.container.innerHTML = `
                    <div class="flex flex-col h-full bg-white p-4">
                        <div class="flex items-center justify-between gap-2 mb-3">
                            <div class="flex items-center gap-2">
                                <select class="border rounded px-2 py-1 text-sm text-gray-800 bg-white" onchange="this.closest('.window-content').app.setMonth(this.value)">
                                    ${monthOptions}
                                </select>
                                <select class="border rounded px-2 py-1 text-sm text-gray-800 bg-white" onchange="this.closest('.window-content').app.setYear(this.value)">
                                    ${yearOptions}
                                </select>
                                <button class="p-1.5 hover:bg-gray-100 rounded" onclick="this.closest('.window-content').app.changeMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                                <button class="p-1.5 hover:bg-gray-100 rounded" onclick="this.closest('.window-content').app.changeMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="date" min="1900-01-01" max="2099-12-31" value="${toInputDate(this.selected)}" class="border rounded px-2 py-1 text-sm text-gray-800 bg-white" onchange="this.closest('.window-content').app.setSelectedFromInput(this.value)">
                                <button class="bg-gray-800 hover:bg-gray-900 active:bg-black text-white text-xs px-3 py-2 rounded" onclick="this.closest('.window-content').app.goToday()">Today</button>
                            </div>
                        </div>
                        <div class="mb-3 text-sm text-gray-700">
                            <span class="font-semibold">Selected:</span> ${selectedLabel}
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center mb-2 font-bold text-gray-500 text-xs uppercase">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center flex-1 content-start">
                            ${gridHtml}
                        </div>
                    </div>
                `;
                this.container.app = this;
            }

            changeMonth(delta) {
                const next = new Date(this.viewYear, this.viewMonth + delta, 1);
                this.viewYear = next.getFullYear();
                this.viewMonth = next.getMonth();
                this.render();
            }

            setYear(val) {
                const y = Number(val);
                if (!Number.isFinite(y)) return;
                this.viewYear = y;
                this.render();
            }

            setMonth(val) {
                const m = Number(val);
                if (!Number.isFinite(m)) return;
                this.viewMonth = Math.max(0, Math.min(11, m));
                this.render();
            }

            selectDay(day) {
                const d = new Date(this.viewYear, this.viewMonth, day);
                const y = d.getFullYear();
                if (y < 1900 || y > 2099) return;
                this.selected = d;
                this.render();
            }

            setSelectedFromInput(value) {
                if (!value) return;
                const parts = value.split('-').map(Number);
                if (parts.length !== 3) return;
                const [y, m, d] = parts;
                if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) return;
                if (y < 1900 || y > 2099) return;
                const next = new Date(y, m - 1, d);
                if (Number.isNaN(next.getTime())) return;
                this.selected = next;
                this.viewYear = next.getFullYear();
                this.viewMonth = next.getMonth();
                this.render();
            }

            goToday() {
                const now = new Date();
                this.selected = now;
                this.viewYear = now.getFullYear();
                this.viewMonth = now.getMonth();
                this.render();
            }
        }

        class SettingsApp {
            constructor(container) {
                this.container = container;
                this.render();
            }
            render() {
                this.container.innerHTML = `
                    <div class="p-6 bg-gray-50 h-full">
                        <h2 class="text-xl font-bold mb-4">Settings</h2>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">Desktop Wallpaper</label>
                            <div class="grid grid-cols-3 gap-4 mt-2">
                                <div class="aspect-video bg-blue-500 cursor-pointer rounded border-2 border-transparent hover:border-blue-500" onclick="document.getElementById('desktop').style.backgroundImage = 'linear-gradient(to bottom right, #1e3a8a, #581c87)'"></div>
                                <div class="aspect-video bg-green-500 cursor-pointer rounded border-2 border-transparent hover:border-blue-500" onclick="document.getElementById('desktop').style.backgroundImage = 'linear-gradient(to bottom right, #064e3b, #065f46)'"></div>
                                <div class="aspect-video bg-gray-800 cursor-pointer rounded border-2 border-transparent hover:border-blue-500" onclick="document.getElementById('desktop').style.backgroundImage = ''"></div>
                            </div>
                        </div>
                        <button class="bg-red-500 text-white px-4 py-2 rounded" onclick="localStorage.removeItem('webos_vfs'); location.reload()">Reset System</button>
                    </div>
                `;
            }
        }

        // --- System Boot ---
        window.addEventListener('load', () => {
            // Clock
            setInterval(() => {
                const now = new Date();
                $('#clock-time').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                $('#clock-date').textContent = now.toLocaleDateString();
            }, 1000);

            // Start Menu Toggle
            $('#start-btn').onclick = () => {
                const menu = $('#start-menu');
                menu.classList.toggle('hidden');
                setTimeout(() => {
                    menu.classList.toggle('opacity-0');
                    menu.classList.toggle('scale-95');
                }, 10);
            };

            // Close start menu when clicking outside
            $('#desktop').onclick = (e) => {
                if(!e.target.closest('#start-menu') && !e.target.closest('#start-btn')) {
                    const menu = $('#start-menu');
                    if(!menu.classList.contains('hidden')) {
                        menu.classList.add('opacity-0', 'scale-95');
                        setTimeout(() => menu.classList.add('hidden'), 200);
                    }
                }
            };

            // Fill Start Menu
            const grid = $('#start-menu-grid');
            Object.entries(Apps).forEach(([id, app]) => {
                const el = document.createElement('div');
                el.className = 'flex flex-col items-center cursor-pointer hover:bg-gray-700 rounded p-2 transition-colors';
                el.innerHTML = `<i class="${app.icon} ${app.color} text-2xl mb-2"></i><span class="text-xs text-center">${app.name}</span>`;
                el.onclick = () => {
                    WindowManager.open(id);
                    $('#start-menu').classList.add('hidden');
                };
                grid.appendChild(el);
            });

            // Boot Animation
            setTimeout(() => {
                $('#boot-progress').style.width = '100%';
            }, 500);

            setTimeout(() => {
                $('#boot-screen').style.opacity = '0';
                setTimeout(() => $('#boot-screen').remove(), 500);
                $('#desktop').classList.remove('hidden');
                WindowManager.refreshDesktop();
            }, 2500);

            window.addEventListener('resize', () => WindowManager.refreshDesktop());
            
            // Context Menu
            window.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const menu = $('#context-menu');
                menu.style.left = e.clientX + 'px';
                menu.style.top = e.clientY + 'px';
                menu.classList.remove('hidden');
                
                // Determine context
                // For simplicity, default to Desktop
                window.ContextMenu = { targetPath: '/Desktop' };
            });
            
            window.addEventListener('click', () => $('#context-menu').classList.add('hidden'));

        });

        async function initPyodideRuntime() {
            if (window.pyodide) return window.pyodide;
            if (typeof window.loadPyodide !== 'function') {
                throw new Error('Pyodide loader not found. Please refresh and ensure network access.');
            }
            window.pyodide = await window.loadPyodide({ indexURL : "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/" });
            return window.pyodide;
        }

    </script>
</body>
</html>
